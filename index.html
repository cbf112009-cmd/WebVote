<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>去中心化投票系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --glass: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header { text-align: center; padding: 2rem; margin-bottom: 1rem; }
        h1 { margin: 0; font-size: 2.5rem; letter-spacing: 2px; }
        p.subtitle { color: var(--secondary); margin-top: 0.5rem; }

        .container {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            margin-bottom: 2rem;
            transition: transform 0.3s ease;
        }

        .container:hover { transform: translateY(-5px); }

        button {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border: none;
            padding: 10px 20px;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover { opacity: 0.9; transform: scale(1.02); }
        button:disabled { background: #555; cursor: not-allowed; }

        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.2);
            color: white;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .candidate-list { list-style: none; padding: 0; }
        .candidate-item {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .vote-count { font-weight: bold; color: var(--secondary); }
        #status { margin-top: 10px; text-align: center; font-size: 0.9rem; color: #ff7675; white-space: pre-wrap; }
        .section-title { border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; margin-bottom: 15px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <h1>區塊鏈投票系統</h1>
        <p class="subtitle">安全．透明．不可竄改</p>
        <div id="walletAddress" style="margin-top: 10px; font-family: monospace; color: #fab1a0;">尚未連接錢包</div>
    </header>

    <div id="connectSection" class="container">
        <h2 class="section-title">步驟 1: 連接錢包</h2>
        <p>請使用 MetaMask 連接並確保位於 <b>Sepolia 測試網</b>。</p>
        <button onclick="connectWallet()">連接 MetaMask</button>
    </div>

    <div id="registerSection" class="container hidden">
        <h2 class="section-title">步驟 2: 身份註冊</h2>
        <p>您尚未註冊。請輸入姓名以獲取投票權。</p>
        <input type="text" id="userName" placeholder="輸入您的姓名">
        <button onclick="registerUser()">註冊身份</button>
    </div>

    <div id="votingSection" class="container hidden">
        <h2 class="section-title">步驟 3: 候選人列表</h2>
        <p>請選擇一位候選人進行投票（一人一票）。</p>
        <ul id="candidateList" class="candidate-list"></ul>
        <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
             <h3>目前最高票：<span id="winningInfo" style="color: var(--secondary)">計算中...</span></h3>
        </div>
    </div>

    <p id="status"></p>

    <script>
        // ================= 配置區域 =================
        const REGISTRY_ADDRESS = "0xBe8ECCDC54d8130537Baf9948B8dFC4Fe9245C2C"; 
        const VOTING_ADDRESS = "0xCff9ba6c2F6Fba392A62277DdD75FA4661838b30";
        const TARGET_CHAIN_ID = "0xaa36a7"; // Sepolia (11155111) 的十六進位
        // ===========================================

        let provider, signer, registryContract, votingContract, userAddress;

        const RegistryABI = [
            "function register(string memory _name) public",
            "function isRegistered(address) public view returns (bool)"
        ];

        const VotingABI = [
            "function vote(uint256 candidateIndex) public",
            "function getCandidateCount() public view returns (uint256)",
            "function getCandidate(uint256 index) public view returns (string memory, uint256)",
            "function hasVoted(address) public view returns (bool)",
            "function winningCandidate() public view returns (uint256, string memory, uint256)"
        ];

        // 2. 自動監聽帳號與網路切換
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => window.location.reload());
            window.ethereum.on('chainChanged', () => window.location.reload());
        }

        async function connectWallet() {
            try {
                if (!window.ethereum) return alert("請安裝 MetaMask!");
                
                // 檢查網路是否為 Sepolia
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== TARGET_CHAIN_ID) {
                    showStatus("請將網路切換至 Sepolia 測試網！");
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: TARGET_CHAIN_ID }],
                        });
                    } catch (e) { return; }
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                document.getElementById("walletAddress").innerText = `已連接: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                document.getElementById("connectSection").classList.add("hidden");

                registryContract = new ethers.Contract(REGISTRY_ADDRESS, RegistryABI, signer);
                votingContract = new ethers.Contract(VOTING_ADDRESS, VotingABI, signer);

                checkUserStatus();
            } catch (err) {
                console.error(err);
                showStatus("連接失敗: " + err.message);
            }
        }

        async function checkUserStatus() {
            try {
                showStatus("檢查註冊狀態中...");
                const isRegistered = await registryContract.isRegistered(userAddress);

                if (isRegistered) {
                    document.getElementById("registerSection").classList.add("hidden");
                    document.getElementById("votingSection").classList.remove("hidden");
                    loadCandidates();
                } else {
                    document.getElementById("registerSection").classList.remove("hidden");
                    document.getElementById("votingSection").classList.add("hidden");
                }
                showStatus("");
            } catch (err) {
                // 3. 顯示具體錯誤，幫助診斷是否地址填錯
                showStatus("檢查失敗！原因：\n" + (err.reason || "無法讀取合約。請確認您在 Sepolia 網路且地址正確。"));
            }
        }

        async function registerUser() {
            const name = document.getElementById("userName").value;
            if (!name) return alert("請輸入姓名");
            try {
                showStatus("正在發送註冊交易...");
                const tx = await registryContract.register(name);
                showStatus("註冊中，請稍候...");
                await tx.wait();
                showStatus("註冊成功！");
                checkUserStatus();
            } catch (err) {
                showStatus("註冊失敗: " + (err.reason || err.message));
            }
        }

        async function loadCandidates() {
            const list = document.getElementById("candidateList");
            list.innerHTML = "載入候選人中...";
            try {
                const count = await votingContract.getCandidateCount();
                const hasVoted = await votingContract.hasVoted(userAddress);
                let html = "";
                for (let i = 0; i < count; i++) {
                    const candidate = await votingContract.getCandidate(i);
                    html += `
                        <li class="candidate-item">
                            <span>${candidate[0]}</span>
                            <div>
                                <span class="vote-count">${candidate[1].toString()} 票</span>
                                ${!hasVoted ? `<button style="width: auto; margin-left: 10px; font-size: 0.8rem;" onclick="vote(${i})">投票</button>` : '<span style="margin-left:10px; color:#aaa">(已投)</span>'}
                            </div>
                        </li>`;
                }
                list.innerHTML = html;
                updateWinner();
            } catch (err) {
                list.innerHTML = "載入失敗：" + (err.reason || "請確認投票合約地址。");
            }
        }

        async function vote(index) {
            try {
                showStatus("投票交易處理中...");
                const tx = await votingContract.vote(index);
                await tx.wait();
                showStatus("投票成功！");
                loadCandidates();
            } catch (err) {
                showStatus("投票失敗: " + (err.reason || err.message));
            }
        }

        async function updateWinner() {
            try {
                const winner = await votingContract.winningCandidate();
                document.getElementById("winningInfo").innerText = `${winner[1]} (${winner[2]} 票)`;
            } catch(err) {
                document.getElementById("winningInfo").innerText = "尚無資料";
            }
        }

        function showStatus(msg) { document.getElementById("status").innerText = msg; }
    </script>
</body>
</html>