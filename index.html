<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniGov | çµ‚æ¥µå»ä¸­å¿ƒåŒ–æ²»ç†å¹³å°</title>

    <!-- å¤–éƒ¨åº«è¼‰å…¥ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK (æ•¸æ“šåŒæ­¥) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'unigov-v1';

        window.govDB = { db, auth, collection, doc, setDoc, getDocs, appId, signInAnonymously, signInWithCustomToken };
    </script>

    <style>
        :root {
            --p: #6366f1; --p-dark: #4f46e5; --bg: #0b0f1a; --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1); --text: #f8fafc; --muted: #94a3b8;
            --success: #10b981; --error: #ef4444; --warning: #f1c40f;
        }

        * { box-sizing: border-box; transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; min-height: 100vh; background-image: radial-gradient(circle at 50% -20%, #1e1b4b 0%, var(--bg) 80%);
            overflow-x: hidden;
        }

        /* å°è¦½åˆ— */
        .nav {
            backdrop-filter: blur(12px); background: rgba(11, 15, 26, 0.8);
            padding: 15px 5%; display: flex; align-items: center; gap: 15px;
            position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border);
        }
        .nav-brand { font-weight: 800; font-size: 1.5rem; color: var(--p); cursor: pointer; }
        .net-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 50px; background: var(--error); color: white; }
        .net-ok { background: var(--success); }

        .user-chip { background: var(--glass); border: 1px solid var(--border); padding: 5px 15px; border-radius: 50px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar-nav { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--p); object-fit: cover; }

        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px 100px; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--glass); border: 1px solid var(--border); border-radius: 24px; padding: 30px; margin-bottom: 20px; position: relative; overflow: hidden; }

        /* ç‹€æ…‹æ¨™ç±¤èˆ‡æ™‚é–“ */
        .status-tag { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .status-active { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .status-closed { background: rgba(148, 163, 184, 0.2); color: var(--muted); }
        .timer-badge { font-size: 0.75rem; color: var(--warning); display: flex; align-items: center; gap: 5px; margin-top: 8px; font-family: monospace; font-weight: 600; }

        .cand-img-wrap { width: 140px; height: 140px; border-radius: 50%; border: 3px solid var(--p); display: flex; align-items: center; justify-content: center; overflow: hidden; margin: 0 auto 15px; background: #111; }
        .cand-img { width: 100%; height: 100%; object-fit: cover; }

        .lvl-container { margin: 25px 0; text-align: left; background: rgba(255,255,255,0.02); padding: 20px; border-radius: 15px; border: 1px solid var(--border); }
        .lvl-bar { width: 100%; height: 14px; background: rgba(0, 0, 0, 0.4); border-radius: 20px; border: 1px solid var(--border); margin-top: 10px; overflow: hidden; }
        .lvl-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #10b981, #f1c40f); width: 0%; transition: 1.5s cubic-bezier(0.1, 0, 0.1, 1); }

        button { background: var(--p); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 8px; justify-content: center; font-size: 0.95rem; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3); }
        button:disabled { background: var(--muted); cursor: not-allowed; opacity: 0.6; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--error); }

        #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #1e293b; border-left: 4px solid var(--p); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); animation: slideIn 0.3s ease; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(11, 15, 26, 0.9); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--p); border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }

        .ranked-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 10px; cursor: grab; display: flex; align-items: center; gap: 15px; }
        .rank-number { width: 30px; height: 30px; border-radius: 50%; background: var(--p); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.8rem; }
        
        input, select { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 10px; color: white; margin-top: 5px; outline: none; }
        .qv-info-badge { background: rgba(241, 196, 15, 0.1); border: 1px solid var(--warning); padding: 15px; border-radius: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }

        /* å€‹äººèº«åˆ† Modal */
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 40px; border-radius: 24px; border: 1px solid var(--p); z-index: 4000; width: 90%; max-width: 500px; display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3999; display: none; backdrop-filter: blur(5px); }

        .time-inputs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .time-unit { text-align: center; }
        .time-unit label { font-size: 0.7rem; color: var(--muted); margin-bottom: 5px; display: block; }

        #log { background: #000; color: #10b981; font-family: monospace; padding: 20px; border-radius: 15px; height: 160px; overflow-y: auto; font-size: 13px; border: 1px solid var(--border); line-height: 1.6; }
    </style>
</head>

<body>

    <div id="mainLoader" class="loading-overlay"><span class="loader"></span></div>
    <div id="modalOverlay" class="modal-overlay" onclick="closeProfileModal()"></div>
    <div id="toast-container"></div>
    
    <!-- èº«åˆ†ç·¨è¼¯ Modal -->
    <div id="profileModal" class="modal">
        <h2 style="margin-bottom:20px;">ä¿®æ”¹æ²»ç†èº«åˆ†</h2>
        <label style="color:var(--muted); font-size:0.8rem;">æ²»ç†æš±ç¨±</label>
        <input type="text" id="editUserName" placeholder="è¼¸å…¥æ–°çš„åç¨±">
        <label style="margin-top:15px; display:block; color:var(--muted); font-size:0.8rem;">é ­åƒ CID (IPFS Hash)</label>
        <input type="text" id="editUserAvatar" placeholder="Qm... æˆ–ç•™ç©ºä½¿ç”¨é è¨­">
        <div style="display:flex; gap:10px; margin-top:30px;">
            <button class="btn-ghost" style="flex:1" onclick="closeProfileModal()">å–æ¶ˆ</button>
            <button style="flex:1" onclick="handleUpdateProfile()">åŒæ­¥è‡³éˆä¸Š</button>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-brand" onclick="showPage('guidePage')"><i class="fa-solid fa-atom"></i> UniGov</div>
        <div id="netStatus" class="net-badge">æ­£åœ¨åµæ¸¬...</div>
        <div style="display:flex; gap:8px;">
            <button class="btn-ghost" onclick="showPage('guidePage')">å¼•å°</button>
            <button class="btn-ghost" onclick="showPage('listPage')">å¤§å»³</button>
            <button class="btn-ghost" onclick="showPage('modeInfoPage')">ç™¾ç§‘</button>
            <button class="btn-ghost" onclick="showPage('statPage')">å¯©è¨ˆ</button>
            <button class="btn-ghost" onclick="showPage('wheelPage')">è½‰ç›¤</button>
        </div>
        <div id="userSection" style="margin-left:auto; display:flex; align-items:center; gap:15px;">
            <div id="userInfo" class="user-chip" style="display:none" onclick="showPage('profilePage')">
                <img id="navAvatar" src="" class="avatar-nav">
                <span id="navName">...</span>
                <span id="navRep" style="color:var(--warning); font-weight:bold;">Rep: 0</span>
            </div>
            <button id="connBtn" onclick="connectWalletFlow()"><i class="fa-solid fa-wallet"></i> é€£æ¥éŒ¢åŒ…</button>
            <button id="discoBtn" class="btn-ghost" style="display:none" onclick="disconnectWallet()"><i class="fa-solid fa-right-from-bracket"></i></button>
            <button onclick="showPage('createPage')"><i class="fa-solid fa-plus"></i> ææ¡ˆ</button>
        </div>
    </nav>

    <div class="container">

        <!-- 1. å¼•å°é é¢ (Onboarding 1-2-3) -->
        <div id="guidePage" class="page active">
            <div class="card" style="text-align:center; padding:80px 40px;">
                <h1>UniGov æ²»ç†ç”Ÿæ…‹ä¸­æ¨</h1>
                <p style="color:var(--muted); font-size:1.1rem;">æ•´åˆèº«åˆ†ä¸»æ¬Šã€å¤šç¶­è¨ˆç¥¨èˆ‡ç²¾æº–æ™‚é–“ç®¡æ§ã€‚æ•¸æ“šå…¨ç¶²éˆä¸ŠåŒæ­¥ã€‚</p>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-top:40px; text-align:left;">
                    <div class="card"><b style="color:var(--p); font-size:1.3rem;">01</b><h3>å»ºç«‹èº«åˆ†</h3><p>é€£æ¥éŒ¢åŒ…åŸ·è¡Œè¨»å†Šï¼Œå°‡åœ°å€è½‰åŒ–ç‚ºå…·å‚™è²è­½ (Rep) çš„æ²»ç†èº«åˆ†ã€‚</p></div>
                    <div class="card"><b style="color:var(--p); font-size:1.3rem;">02</b><h3>åƒèˆ‡å…±è­˜</h3><p>æä¾›äº”å¤§è¨ˆç¥¨æ¨¡å¼ï¼Œè¨­å®šç²¾æº–æ±ºç­–é€±æœŸã€‚æ•¸æ“šéˆä¸Šå­˜è­‰ï¼Œç§’ç´šå€’æ•¸ã€‚</p></div>
                    <div class="card"><b style="color:var(--p); font-size:1.3rem;">03</b><h3>ç´¯ç©æ¦®è­½</h3><p>é€éæŠ•ç¥¨èˆ‡ç°½åˆ°æå‡ Repï¼Œåœ¨æˆå°±ç‰†å±•ç¤ºæ‚¨çš„å»ä¸­å¿ƒåŒ–æ²»ç†è³‡æ­·ã€‚</p></div>
                </div>
                <button style="margin:40px auto; padding:18px 50px;" onclick="showPage('listPage')">ç«‹å³é–‹å•Ÿå…±è­˜ä¹‹æ—…</button>
            </div>
        </div>

        <!-- 2. å¤§å»³é é¢ (æœå°‹ã€ç²¾æº–å€’æ•¸) -->
        <div id="listPage" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <h1>æ²»ç†è­°æ¡ˆä¸­å¿ƒ</h1>
                <input type="text" id="searchBar" onkeyup="filterPolls()" placeholder="æœå°‹æ¨™é¡Œã€UID æˆ–ç™¼èµ·ä½å€..." style="width:350px;">
            </div>
            <div id="pollGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:24px;"></div>
        </div>

        <!-- 3. å¯©è¨ˆçœ‹æ¿ (æ—¥èªŒåŒ¯å‡º) -->
        <div id="statPage" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1>æ²»ç†è¶¨å‹¢å¯©è¨ˆ (éˆä¸Š Tx Hash è¿½è¹¤)</h1>
                <button class="btn-ghost" onclick="handleExportAudit()"><i class="fa-solid fa-download"></i> åŒ¯å‡ºå¯©è¨ˆæ—¥èªŒ CSV</button>
            </div>
            <div class="card" style="min-height: 350px;"><canvas id="mainChart" height="150"></canvas></div>
            <div id="log">> ç³»çµ±ç‹€æ…‹ï¼šæ­£åœ¨ç´¢å¼•å€å¡Šéˆå¯¦æ™‚äº‹ä»¶æµï¼Œç¢ºä¿æ•¸æ“šå…·å‚™ Traceability...</div>
        </div>

        <!-- 4. å¹¸é‹è½‰ç›¤ -->
        <div id="wheelPage" class="page" style="text-align:center">
            <h1>æ²»ç†é‹å‹¢è½‰ç›¤</h1>
            <div class="wheel-wrap"><div class="wheel-pointer"></div><div id="wheel"></div></div>
            <button style="margin:30px auto;" onclick="spinWheel()">æŠ½å–ä»Šæ—¥ç¨±è™Ÿ</button>
            <h2 id="wheelResult" style="color:var(--warning); min-height:40px;"></h2>
        </div>

        <!-- 5. ç™¾ç§‘é é¢ (1-5 ç·¨è™Ÿ) -->
        <div id="modeInfoPage" class="page">
            <h1>æ²»ç†æ¨¡å¼ç™¾ç§‘å…¨æ›¸</h1>
            <div style="display:grid; gap:20px;">
                <div class="card"><h3>1. ä¸€èˆ¬æ¨¡å¼ (Standard)</h3><p>ä¸€äººä¸€ç¥¨ï¼Œæœ€ç´”ç²¹çš„æ°‘ä¸»åŸºæº–ã€‚å…¬å¼ï¼š$å¾—ç¥¨ = \sum é¸æ°‘æ•¸$</p></div>
                <div class="card"><h3>2. å¹³æ–¹æŠ•ç¥¨ (Quadratic)</h3><p>æˆæœ¬éš¨ç¥¨æ•¸å¹³æ–¹å¢é•·ã€‚å…¬å¼ï¼š$æ¶ˆè€— = ç¥¨æ•¸^2$ã€‚æœ‰æ•ˆé˜²æ­¢å¤§æˆ¶éœ¸å‡Œã€‚</p></div>
                <div class="card"><h3>3. å¹³æ–¹å‹Ÿè³‡ (QF)</h3><p>é‡è¦–äººæ•¸è€Œéé‡‘é¡ã€‚å…¬å¼ï¼š$çå‹µ \propto (\sum \sqrt{æåŠ©})^2$ã€‚å„ªåŒ–é ç®—åˆ†é…ã€‚</p></div>
                <div class="card"><h3>4. åå¥½æ’åº (Ranked Choice)</h3><p>æ‹–æ›³æ’åºé¸é …ï¼Œç›´åˆ°é¸å‡ºå¤§çœ¾å…¬ç´„æ•¸æœ€é«˜è€…ã€‚æ¶ˆé™¤æ£„ä¿æ•ˆæ‡‰ã€‚</p></div>
                <div class="card"><h3>5. æ¬Šé‡æŠ•ç¥¨ (Weighted Voting)</h3><p>æ²»ç†æ¬Šä¾æ“šä»£å¹£æŒå€‰æˆ– Rep æ¬Šé‡æ±ºå®šã€‚å…¬å¼ï¼š$å¾—ç¥¨ = ç¥¨æ•¸ \times æ¬Šé‡$</p></div>
            </div>
        </div>

        <!-- 6. å€‹äººé¢æ¿ (ç°½åˆ°å¤§ä¸€çµ± & èº«åˆ†ä¿®æ”¹) -->
        <div id="profilePage" class="page">
            <div class="card" style="max-width:650px; margin:0 auto; text-align:center">
                <h2>å€‹äººæ²»ç†è€…å„€è¡¨æ¿</h2>
                <div id="regAlert" style="background:rgba(239,68,68,0.1); border:1px solid var(--error); padding:15px; border-radius:15px; margin-bottom:20px; display:none;">
                    <b>å°šæœªè¨»å†Šèº«åˆ†</b><br>
                    <button onclick="handleRegisterOnChain()" class="btn-danger" style="margin:10px auto;">åŸ·è¡Œéˆä¸Šè¨»å†Š</button>
                </div>
                <img id="profileAvatar" src="" style="width:130px; height:130px; border-radius:50%; border:3px solid var(--p); margin: 20px 0; object-fit:cover;">
                <div style="margin-bottom:20px;"><button class="btn-ghost" onclick="openProfileModal()"><i class="fa-solid fa-user-pen"></i> ä¿®æ”¹èº«åˆ†åç¨±/é ­åƒ</button></div>
                
                <div class="lvl-container">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <b id="lvlTitle" style="color:var(--warning)">è¼‰å…¥ä¸­...</b>
                        <span id="repStatus">æ²»ç†è²æœ›ï¼š0</span>
                    </div>
                    <div class="lvl-bar"><div id="lvlFill" class="lvl-fill"></div></div>
                    <p style="font-size:0.75rem; color:var(--muted); margin-top:10px;">æ•´åˆ Rep = éˆä¸Šæ•¸æ“š + æœ¬åœ°ç°½åˆ°çå‹µ</p>
                </div>

                <div class="task-list">
                    <div class="card" style="padding:15px; border:1px solid var(--border); display:flex; align-items:center; gap:15px;">
                        <div style="flex:1; text-align:left;"><b>æ¯æ—¥æ²»ç†ç°½åˆ°</b><br><small>ç«‹å³ç²å¾— +10 Rep (å…¨ç«™åŒæ­¥)</small></div>
                        <button onclick="handleDailyCheckIn()" id="checkInBtn" class="btn-success">åŸ·è¡Œç°½åˆ°</button>
                    </div>
                </div>

                <div style="margin-top:20px; border:1px dashed var(--border); padding:20px; border-radius:20px;">
                    <h4>ç¨±è™Ÿæˆå°±æ”¶è—å®¤</h4>
                    <div id="titleCollection" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:10px;"></div>
                </div>

                <button class="btn-danger" style="width:100%; margin-top:25px;" onclick="disconnectWallet()">æ–·é–‹é€£æ¥</button>
            </div>
        </div>

        <!-- 7. ç™¼èµ·ææ¡ˆé é¢ (UID è‡ªå‹•è£œå…¨ & ç²¾æº–æ™‚é–“) -->
        <div id="createPage" class="page">
            <div class="card" style="max-width:800px; margin:0 auto">
                <h2>éƒ¨ç½²éˆä¸Šæ²»ç†è­°æ¡ˆ</h2>
                <label>è­°æ¡ˆæ¨™é¡Œ</label>
                <input type="text" id="topic" placeholder="ä¾‹ï¼šèª°æ˜¯ 2026 å¹´åº¦æœ€ä½³æ²»ç†é …ç›®ï¼Ÿ">
                
                <div style="margin-top:15px;">
                    <label>æ²»ç†æ¨¡å¼ (æ”¯æ´ 0-4)</label>
                    <select id="modeSelect">
                        <option value="0">0 - ä¸€èˆ¬æ¨¡å¼ (Standard)</option>
                        <option value="1">1 - å¹³æ–¹æŠ•ç¥¨ (Quadratic)</option>
                        <option value="2">2 - å¹³æ–¹å‹Ÿè³‡ (QF Matching)</option>
                        <option value="3">3 - åå¥½æ’åº (Ranked Choice)</option>
                        <option value="4">4 - æ¬Šé‡æŠ•ç¥¨ (Weighted Voting)</option>
                    </select>
                </div>

                <div style="margin-top:15px;">
                    <label>æŒçºŒæ™‚é–“è¨­ç½® (å¤©/æ™‚/åˆ†/ç§’)</label>
                    <div class="time-inputs">
                        <div class="time-unit"><label>æ—¥</label><input type="number" id="pollDay" value="1" min="0"></div>
                        <div class="time-unit"><label>æ™‚</label><input type="number" id="pollHour" value="0" min="0" max="23"></div>
                        <div class="time-unit"><label>åˆ†</label><input type="number" id="pollMin" value="0" min="0" max="59"></div>
                        <div class="time-unit"><label>ç§’</label><input type="number" id="pollSec" value="0" min="0" max="59"></div>
                    </div>
                </div>

                <div id="candidateInputsContainer" style="margin-top:20px;">
                    <h4 style="margin-bottom:10px;">å€™é¸é¸é …</h4>
                </div>
                <button class="btn-ghost" onclick="addCandidateInput()" style="width:100%; margin-top:10px;">æ–°å¢é¸é …</button>
                <button id="submitCreateBtn" onclick="handleCreatePoll()" style="width:100%; margin-top:30px; height:60px;">éƒ¨ç½²è­°æ¡ˆ</button>
            </div>
        </div>

        <!-- 8. è©³æƒ…é é¢ (å€’æ•¸ã€ç·¨è¼¯é–ã€åŒ¯å‡º) -->
        <div id="detailPage" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button class="btn-ghost" onclick="showPage('listPage')"><i class="fa-solid fa-arrow-left"></i> è¿”å›åˆ—è¡¨</button>
                <button class="btn-ghost" onclick="handleExportPoll()"><i class="fa-solid fa-file-export"></i> åŒ¯å‡ºè¨ˆç¥¨å ±å‘Š</button>
            </div>
            <div id="pollInfo" class="card" style="border-left: 8px solid var(--p);"></div>
            
            <div id="qvCreditsUI" class="qv-info-badge" style="display:none;">
                <span>æ²»ç†é»æ•¸é¤˜é¡ï¼š<b id="userCreditsDisplay" style="color:var(--warning)">0</b></span>
                <span id="qvCostPreview" style="font-weight:800; color:var(--warning);">é ç®—æ¶ˆè€—ï¼š0 é»</span>
            </div>

            <div id="oracleSection" class="card" style="border: 2px solid var(--p);">
                <h3>æ²»ç†é è¨€æ©Ÿ (Oracle)</h3>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <select id="oracleGuess" style="flex:2; padding:10px; background:#000; color:white; border-radius:8px;"></select>
                    <button onclick="handleOracleBet()" class="btn-success" style="flex:1;">æäº¤é æ¸¬</button>
                </div>
            </div>

            <div id="creatorEditSection" class="card" style="display:none; border:2px solid var(--warning);">
                <h3 style="color:var(--warning);">ç™¼èµ·äººç·¨è¼¯é¢æ¿ (0 ç¥¨é–å®š)</h3>
                <input type="text" id="editTopic" style="width:100%; padding:10px; background:#000; border:1px solid var(--border); color:white; border-radius:8px;">
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="handleEditPollMetadata()" class="btn-success" style="flex:2;">åŒæ­¥ä¿®æ”¹</button>
                    <button onclick="handleDeletePoll()" class="btn-danger" style="flex:1;">æ¨™è¨˜åˆªé™¤</button>
                </div>
            </div>

            <div class="card" style="text-align:center">
                <div class="sentiment-bar" style="display:flex; justify-content:center; gap:15px;">
                    <div class="sentiment-btn" onclick="notify('å·²åæ‡‰ï¼šç†±è¡€ï¼','success')">ğŸ”¥</div>
                    <div class="sentiment-btn" onclick="notify('å·²åæ‡‰ï¼šè§€æœ›ã€‚','info')">ğŸ¤”</div>
                    <div class="sentiment-btn" onclick="notify('å·²åæ‡‰ï¼šçœ‹å¥½ï¼','success')">ğŸš€</div>
                </div>
            </div>
            <div id="votingUIContainer"></div>
        </div>

    </div>

    <script type="module">
        const ABI = [
            { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "user", "type": "address" }, { "indexed": false, "internalType": "string", "name": "name", "type": "string" }], "name": "UserRegistered", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "pollId", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "creator", "type": "address" }], "name": "PollCreated", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "pollId", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "voter", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "candidateId", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "weight", "type": "uint256" }], "name": "VoteCast", "type": "event" },
            { "inputs": [{ "internalType": "uint256", "name": "_pid", "type": "uint256" }, { "internalType": "uint256", "name": "_cid", "type": "uint256" }, { "internalType": "uint256", "name": "_val", "type": "uint256" }], "name": "castVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "string", "name": "_t", "type": "string" }, { "internalType": "uint8", "name": "_m", "type": "uint8" }, { "internalType": "string[]", "name": "_n", "type": "string[]" }, { "internalType": "string[]", "name": "_u", "type": "string[]" }, { "internalType": "uint256", "name": "_d", "type": "uint256" }], "name": "createPoll", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "getPollCount", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "allPolls", "outputs": [{ "internalType": "uint256", "name": "id", "type": "uint256" }, { "internalType": "address", "name": "creator", "type": "address" }, { "internalType": "string", "name": "topic", "type": "string" }, { "internalType": "uint8", "name": "mode", "type": "uint8" }, { "internalType": "uint256", "name": "endTime", "type": "uint256" }, { "internalType": "bool", "name": "isActive", "type": "bool" }, { "internalType": "uint256", "name": "totalVotes", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_pid", "type": "uint256" }], "name": "getCandidates", "outputs": [{ "components": [{ "internalType": "string", "name": "name", "type": "string" }, { "internalType": "string", "name": "uid", "type": "string" }, { "internalType": "uint256", "name": "voteWeight", "type": "uint256" }], "internalType": "struct UniGov.Candidate[]", "name": "", "type": "tuple[]" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "_user", "type": "address" }], "name": "getUserDashboard", "outputs": [{ "internalType": "string", "name": "name", "type": "string" }, { "internalType": "uint256", "name": "reputation", "type": "uint256" }, { "internalType": "uint256", "name": "credits", "type": "uint256" }, { "internalType": "bool", "name": "isRegistered", "type": "bool" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "string", "name": "_name", "type": "string" }, { "internalType": "string", "name": "_avatar", "type": "string" }], "name": "register", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_pid", "type": "uint256" }, { "internalType": "string", "name": "_newTopic", "type": "string" }, { "internalType": "string[]", "name": "_newNames", "type": "string[]" }, { "internalType": "string[]", "name": "_newUids", "type": "string[]" }], "name": "updatePollMetadata", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
        ];

        const CONTRACT_ADDR = "0xc438c3f6131030Ac5e7070FFFe7434559a9cdd3b"; 
        const DEPLOY_BLOCK = 7000000;
        let provider, signer, userAddr, contract, onChainRep = 0, userCredits = 0, userTitles = [], isRegisteredOnChain = false, localRepBonus = 0, currentPid = null, timerInterval = null, chartInstance = null;

        // --- ä¿®å¾©ï¼šé€šçŸ¥ç³»çµ±é˜²è­· ---
        window.notify = (m, t) => {
            let container = document.getElementById("toast-container");
            if (!container) {
                container = document.createElement("div");
                container.id = "toast-container";
                document.body.appendChild(container);
            }
            const div = document.createElement("div");
            div.className = "toast";
            div.style.borderLeftColor = t === 'error' ? 'var(--error)' : 'var(--p)';
            div.innerText = m;
            container.appendChild(div);
            setTimeout(() => { if(div) div.remove(); }, 4000);
        };

        window.showPage = (id) => {
            if (timerInterval) clearInterval(timerInterval);
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(id);
            if (target) target.classList.add('active');
            if (id === 'statPage') { initChartFrame(); updateAuditTrend(); }
            window.scrollTo(0, 0);
        };

        async function fetchWithTimeout(promise, timeout = 5000) {
            const tPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('RPC è¶…æ™‚')), timeout));
            return Promise.race([promise, tPromise]);
        }

        // --- é€£ç·šåˆå§‹åŒ– ---
        async function init() {
            if (!window.ethereum) { 
                if (!document.getElementById("toast-container")) { setTimeout(init, 200); return; }
                window.notify("è«‹å®‰è£ MetaMask æ“´å……åŠŸèƒ½", "error"); 
                return; 
            }
            provider = new ethers.providers.Web3Provider(window.ethereum);
            const { signInAnonymously, auth } = window.govDB;
            await signInAnonymously(auth).catch(() => {});
            if (sessionStorage.getItem('explicitLogout') === 'true') { document.getElementById("connBtn").style.display = "block"; return; }
            try {
                const accounts = await provider.listAccounts();
                if (accounts.length > 0) await setupSession(accounts[0]);
                else document.getElementById("connBtn").style.display = "block";
            } catch (e) {}
        }

        async function setupSession(addr) {
            try {
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111) { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: "0xaa36a7" }] }); }
                signer = provider.getSigner();
                userAddr = addr;
                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
                loadPersistedData();
                await syncUserDashboard();
                renderPolls();
                contract.on("PollCreated", renderPolls);
                contract.on("VoteCast", () => { if(currentPid !== null) viewDetail(currentPid); });
                window.notify("éŒ¢åŒ…é€£ç·šæˆåŠŸ", "success");
            } catch (e) { window.notify("é€£ç·šç•°å¸¸", "error"); }
        }
        window.connectWalletFlow = async function() {
            try { sessionStorage.removeItem('explicitLogout'); const accs = await provider.send("eth_requestAccounts", []); if(accs.length > 0) await setupSession(accs[0]); } catch (e) {}
        };

        async function syncUserDashboard() {
            if (!contract || !userAddr) return;
            try {
                const dash = await fetchWithTimeout(contract.getUserDashboard(userAddr));
                isRegisteredOnChain = dash.isRegistered;
                onChainRep = dash.reputation.toNumber();
                userCredits = dash.credits.toNumber();
                document.getElementById("userInfo").style.display = "flex";
                document.getElementById("connBtn").style.display = "none";
                document.getElementById("discoBtn").style.display = "block";
                document.getElementById("regAlert").style.display = isRegisteredOnChain ? "none" : "block";
                updateUI();
            } catch (e) {}
        }

        function updateUI() {
            if (!userAddr) return;
            const totalRep = onChainRep + localRepBonus;
            document.getElementById("navRep").innerText = "Rep: " + totalRep;
            document.getElementById("navName").innerText = userAddr.substring(0, 6) + "...";
            document.getElementById("navAvatar").src = `https://api.dicebear.com/7.x/identicon/svg?seed=${userAddr}`;
            document.getElementById("repStatus").innerText = `æ²»ç†è²æœ›: ${totalRep}`;
            document.getElementById("profileAvatar").src = `https://api.dicebear.com/7.x/identicon/svg?seed=${userAddr}`;
            
            let lvl = "ğŸŒ± èŒèŠ½"; let fill = (totalRep / 50) * 100;
            if (totalRep > 50) { lvl = "ğŸ›¡ï¸ åŸ·æ³•è€…"; fill = ((totalRep - 50) / 100) * 100; }
            if (totalRep > 150) { lvl = "âš–ï¸ ä»²è£å®˜"; fill = ((totalRep - 150) / 150) * 100; }
            if (totalRep > 300) { lvl = "ğŸ‘‘ å‚³å¥‡"; fill = ((totalRep - 300) / 200) * 100; }
            document.getElementById("lvlTitle").innerText = "ç¨±è™Ÿï¼š" + lvl;
            document.getElementById("lvlFill").style.width = Math.min(fill, 100) + "%";
            
            const tc = document.getElementById("titleCollection"); 
            if(tc) tc.innerHTML = userTitles.map(t => `<span style="background:var(--p); color:white; padding:3px 10px; border-radius:50px; font-size:0.7rem; margin:2px;">${t}</span>`).join('') || '<small>å°šç„¡æˆå°±</small>';
        }

        // --- æ™‚é–“æ ¼å¼åŒ–ï¼šå¤©æ™‚åˆ†ç§’ç²¾æº–åŒ– ---
        function formatTimeFull(seconds) {
            if (seconds <= 0) return "å·²æˆªæ­¢";
            const d = Math.floor(seconds / (3600 * 24));
            const h = Math.floor((seconds % (3600 * 24)) / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${d}å¤© ${h}æ™‚ ${m}åˆ† ${s}ç§’`;
        }

        async function renderPolls() {
            const grid = document.getElementById("pollGrid");
            if(!contract) return;
            try {
                const count = (await fetchWithTimeout(contract.getPollCount())).toNumber();
                let html = "";
                for(let i = count - 1; i >= 0; i--) {
                    const p = await fetchWithTimeout(contract.allPolls(i));
                    if (p.topic.startsWith("[DELETED]")) continue;
                    const timeLeft = p.endTime.toNumber() - Math.floor(Date.now() / 1000);
                    const isExp = timeLeft <= 0;
                    html += `
                        <div class="card" onclick="viewDetail(${i})" style="cursor:pointer; border-top: 5px solid ${isExp ? 'var(--muted)' : 'var(--p)'};">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <h3>${p.topic}</h3>
                                <span class="status-tag ${isExp ? 'status-closed' : 'status-active'}">${isExp ? 'å·²æˆªæ­¢' : 'é€²è¡Œä¸­'}</span>
                            </div>
                            <div class="timer-badge"><i class="fa-regular fa-clock"></i> ${formatTimeFull(timeLeft)}</div>
                            <p style="color:var(--muted); font-size:0.8rem; margin-top:12px;">ç´¯è¨ˆæŠ•ç¥¨æ¬Šé‡ï¼š${p.totalVotes.toString()}</p>
                        </div>`;
                }
                grid.innerHTML = html || '<p>å°šç„¡ç™¼å¸ƒè­°æ¡ˆ</p>';
            } catch (e) {}
        }

        async function viewDetail(pid) {
            currentPid = pid; window.showPage('detailPage');
            const container = document.getElementById("votingUIContainer");
            container.innerHTML = `<p style="text-align:center; padding:20px;">è¼‰å…¥éˆä¸Šæ•¸æ“šä¸­...</p>`;
            try {
                const p = await fetchWithTimeout(contract.allPolls(pid));
                const candidates = await fetchWithTimeout(contract.getCandidates(pid));
                const modes = ["ä¸€èˆ¬", "å¹³æ–¹ (QV)", "å‹Ÿè³‡ (QF)", "æ’åº (Ranked)", "æ¬Šé‡ (Weighted)"];
                
                if(timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    const left = p.endTime.toNumber() - Math.floor(Date.now() / 1000);
                    const el = document.getElementById("detailTimer");
                    if(el) el.innerText = formatTimeFull(left);
                    if(left <= 0) { document.querySelectorAll('.vote-submit-btn').forEach(b => b.disabled = true); }
                }, 1000);

                document.getElementById("pollInfo").innerHTML = `
                    <h1>${p.topic}</h1>
                    <div style="display:flex; gap:10px; margin:12px 0;">
                        <span style="background:var(--p); color:white; padding:4px 15px; border-radius:50px; font-size:0.8rem;">${modes[p.mode]}æ¨¡å¼</span>
                        <span id="detailTimer" style="color:var(--warning); font-size:0.8rem; font-weight:800; font-family:monospace;">${formatTimeFull(p.endTime.toNumber() - Math.floor(Date.now() / 1000))}</span>
                    </div>
                    <p style="color:var(--muted); font-size:0.75rem; margin-top:10px;">ç™¼å¸ƒè€…: ${p.creator}<br>æˆªæ­¢æ—¥æœŸ: ${new Date(p.endTime.toNumber()*1000).toLocaleString()}</p>`;

                document.getElementById("qvCreditsUI").style.display = (p.mode === 1) ? "flex" : "none";
                document.getElementById("userCreditsDisplay").innerText = userCredits;
                document.getElementById("oracleGuess").innerHTML = candidates.map((c, i) => `<option value="${i}">${c.name}</option>`).join('');

                const isCreator = p.creator.toLowerCase() === userAddr.toLowerCase();
                const canEdit = p.totalVotes.toNumber() === 0;
                document.getElementById("creatorEditSection").style.display = (isCreator && canEdit) ? "block" : "none";
                if(isCreator && canEdit) document.getElementById("editTopic").value = p.topic;

                if(p.mode === 3) {
                    // --- æ’åºæ¨¡å¼ ä¿®å¾© ---
                    container.innerHTML = `<div class="card"><h3>æ‹–å‹•æ’åºé¸é … (ç¬¬ä¸€ä½ç‚ºé¦–é¸)</h3><div id="rankedSortList" style="margin:20px 0;">${candidates.map((c, i) => `<div class="ranked-item" data-id="${i}"><div class="rank-number">${i+1}</div><div class="cand-img-wrap" style="width:40px; height:40px; margin:0;"><img src="${resolveCandidateImage(c.uid)}" class="cand-img"></div><div style="flex:1"><b>${c.name}</b></div><i class="fa-solid fa-bars" style="color:var(--muted)"></i></div>`).join('')}</div><button class="btn-success vote-submit-btn" style="width:100%; height:55px;" onclick="govVote(${pid}, -1, false, true)">é€å‡ºæ’åºé¦–é¸æŠ•ç¥¨</button></div>`;
                    new Sortable(document.getElementById("rankedSortList"), { animation: 150, onEnd: () => document.querySelectorAll('.rank-number').forEach((el, idx) => el.innerText = idx + 1) });
                } else {
                    // --- ä¸€èˆ¬æ¨¡å¼ ä¿®å¾© ---
                    container.innerHTML = `
                        ${p.mode === 2 ? `<div class="card" style="border:1px solid var(--success); background:rgba(16,185,129,0.05); margin-bottom:20px; font-size:0.85rem;"><i class="fa-solid fa-calculator"></i> QF è©¦ç®—ï¼šç³»çµ±å°‡ä¾æŠ•å…¥é‡‘é¡é–‹å¹³æ–¹æ ¹åŠ ç¸½å¾Œå¹³æ–¹ä¼°ç®—é…å°é‡‘ã€‚</div>` : ''}
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                            ${candidates.map((c, i) => `
                                <div class="card" style="text-align:center">
                                    <div class="cand-img-wrap"><img src="${resolveCandidateImage(c.uid)}" class="cand-img" onerror="this.src='https://api.dicebear.com/7.x/identicon/svg?seed=E'"></div>
                                    <h3>${c.name}</h3><p>ç´¯ç©æ¬Šé‡: ${c.voteWeight.toString()}</p>
                                    ${p.mode === 1 ? `<input type="number" id="qv-${i}" placeholder="æ•¸é‡" min="1" oninput="updateQVCost()" style="width:80px; margin-bottom:10px; text-align:center;">` : ''}
                                    <button class="vote-submit-btn" onclick="govVote(${pid}, ${i}, ${p.mode === 1})">${p.mode === 1 ? 'åŸ·è¡Œ QV æŠ•ç¥¨' : 'æŠ•ä¸‹ä¸€ç¥¨'}</button>
                                </div>`).join('')}
                        </div>`;
                }
            } catch (e) { container.innerHTML = "æ•¸æ“šåŠ è¼‰å¤±æ•—"; }
        }
        window.viewDetail = viewDetail;

        // --- æ ¸å¿ƒä¿®å¾©ï¼šCID åœ–ç‰‡è§£æ ---
        function resolveCandidateImage(uid) {
            const cidRegex = /(Qm[1-9A-HJ-NP-Za-km-z]{44}|b[a-z2-7]{58}|bafy[a-zA-Z0-9]{40,}|bafk[a-zA-Z0-9]{40,})/;
            const match = (uid||'').match(cidRegex);
            return match ? `https://ipfs.io/ipfs/${match[0]}` : `https://api.dicebear.com/7.x/identicon/svg?seed=${uid||'U'}`;
        }

        window.updateQVCost = () => {
            let total = 0; document.querySelectorAll('input[id^="qv-"]').forEach(i => { const v = parseInt(i.value)||0; total += (v*v); });
            const p = document.getElementById("qvCostPreview"); if(p) { p.innerText = `æ¶ˆè€—è©¦ç®—ï¼š${total} é»`; p.style.color = total > userCredits ? "var(--error)" : "var(--warning)"; document.querySelectorAll(".vote-submit-btn").forEach(btn => btn.disabled = (total > userCredits)); }
        };

        window.govVote = async (pid, cid, isQV, isRanked = false) => {
            let finalCid = cid; let val = 1;
            if (isRanked) {
                const first = document.querySelector('#rankedSortList .ranked-item');
                finalCid = first ? parseInt(first.getAttribute('data-id')) : -1;
            } else if (isQV) {
                val = document.getElementById(`qv-${cid}`).value;
            }
            if(finalCid === -1 || !val || val <= 0) return window.notify("è«‹è¼¸å…¥æœ‰æ•ˆç¥¨æ•¸", "warning");

            const overlay = document.getElementById("mainLoader");
            try { 
                overlay.style.display = "flex"; window.notify("æ­£åœ¨è™•ç†éˆä¸Šäº¤æ˜“...", "info");
                const tx = await contract.castVote(pid, finalCid, val); 
                await tx.wait(); confetti(); syncUserDashboard(); viewDetail(pid);
            } catch (e) { window.notify("äº¤æ˜“å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–ç¯€é»", "error"); } finally { overlay.style.display = "none"; }
        };

        // --- èº«åˆ†æ›´æ–° ---
        window.openProfileModal = () => { 
            document.getElementById("editUserName").value = document.getElementById("navName").innerText.replace("...", "");
            document.getElementById("profileModal").style.display = "block"; 
            document.getElementById("modalOverlay").style.display = "block"; 
        };
        window.closeProfileModal = () => { document.getElementById("profileModal").style.display = "none"; document.getElementById("modalOverlay").style.display = "none"; };
        window.handleUpdateProfile = async () => {
            const overlay = document.getElementById("mainLoader");
            const newName = document.getElementById("editUserName").value;
            const newAvatar = document.getElementById("editUserAvatar").value || "default";
            try { overlay.style.display = "flex"; const tx = await contract.register(newName, newAvatar); await tx.wait(); syncUserDashboard(); closeProfileModal(); window.notify("èº«åˆ†æ›´æ–°æˆåŠŸ", "success"); } catch(e) { window.notify("æ›´æ–°å¤±æ•—", "error"); } finally { overlay.style.display = "none"; }
        };

        // --- ç™¼èµ·ææ¡ˆ ---
        window.handleCreatePoll = async () => {
            const overlay = document.getElementById("mainLoader");
            const d = parseInt(document.getElementById("pollDay").value) || 0;
            const h = parseInt(document.getElementById("pollHour").value) || 0;
            const m = parseInt(document.getElementById("pollMin").value) || 0;
            const s = parseInt(document.getElementById("pollSec").value) || 0;
            const totalMinutes = (d * 1440) + (h * 60) + m + (s / 60);

            const names = Array.from(document.querySelectorAll(".cand-name")).map(i => i.value || "åŒ¿å");
            const uids = Array.from(document.querySelectorAll(".cand-uid")).map(i => i.value || "CAND-" + Math.random().toString(36).substring(2, 6).toUpperCase());
            try { overlay.style.display = "flex"; const tx = await contract.createPoll(document.getElementById("topic").value, document.getElementById("modeSelect").value, names, uids, Math.max(1, Math.floor(totalMinutes))); await tx.wait(); renderPolls(); window.showPage('listPage'); } catch(e) { window.notify("ç™¼èµ·å¤±æ•—", "error"); } finally { overlay.style.display = "none"; }
        };

        window.addCandidateInput = () => {
            const div = document.createElement("div"); div.style.display = "flex"; div.style.gap = "10px"; div.style.marginTop = "8px";
            div.innerHTML = `<input type="text" class="cand-name" placeholder="é¸é …åç¨±"><input type="text" class="cand-uid" placeholder="CID (è‡ªå‹•è£œå…¨)">`;
            document.getElementById("candidateInputsContainer").appendChild(div);
        };

        // --- å…¶ä»–å·¥å…· ---
        window.handleDailyCheckIn = () => { localRepBonus += 10; updateUI(); savePersistedData(); window.notify("ç°½åˆ°æˆåŠŸï¼æ²»ç†è²æœ› +10", "success"); confetti(); };
        window.handleRegisterOnChain = async () => { const overlay = document.getElementById("mainLoader"); try { overlay.style.display = "flex"; const tx = await contract.register("User", "default"); await tx.wait(); syncUserDashboard(); } finally { overlay.style.display = "none"; } };
        window.handleExportPoll = async () => { const cand = await contract.getCandidates(currentPid); let csv = "é¸é …,æ¬Šé‡\n"; cand.forEach(c => csv += `${c.name},${c.voteWeight}\n`); const blob = new Blob(["\uFEFF"+csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `UniGov_Report_${currentPid}.csv`; a.click(); };
        window.handleExportAudit = () => { const csv = "æ™‚é–“,æ—¥èªŒ\n" + new Date().toLocaleString() + "," + document.getElementById("log").innerText; const blob = new Blob(["\uFEFF"+csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'UniGov_Audit.csv'; a.click(); };
        window.handleEditPollMetadata = async () => { const overlay = document.getElementById("mainLoader"); try { overlay.style.display = "flex"; const tx = await contract.updatePollMetadata(currentPid, document.getElementById("editTopic").value, [], []); await tx.wait(); viewDetail(currentPid); } finally { overlay.style.display = "none"; } };
        window.handleDeletePoll = async () => { if(!confirm("æ¨™è¨˜åˆªé™¤ï¼Ÿ")) return; const overlay = document.getElementById("mainLoader"); try { overlay.style.display = "flex"; const p = await contract.allPolls(currentPid); const tx = await contract.updatePollMetadata(currentPid, "[DELETED] " + p.topic, [], []); await tx.wait(); renderPolls(); window.showPage('listPage'); } finally { overlay.style.display = "none"; } };
        window.handleOracleBet = () => { window.notify("é è¨€æäº¤æˆåŠŸ", "success"); confetti(); };
        window.spinWheel = function() { const deg = 1800 + Math.random() * 1800; document.getElementById("wheel").style.transform = `rotate(${deg}deg)`; setTimeout(() => { const res = ["ä»²è£å®˜", "é–‹è·¯è€…", "å®ˆè­·è€…"][Math.floor(Math.random() * 3)]; document.getElementById("wheelResult").innerText = "æŠ½ä¸­ç¨±è™Ÿï¼š"+res; if(!userTitles.includes(res)) { userTitles.push(res); updateUI(); savePersistedData(); } confetti(); }, 4000); };
        window.disconnectWallet = () => { sessionStorage.setItem('explicitLogout', 'true'); location.reload(); };
        
        function loadPersistedData() { if(!userAddr) return; const k = userAddr.toLowerCase(); localRepBonus = parseInt(localStorage.getItem(`bonus_${k}`) || "0"); userTitles = JSON.parse(localStorage.getItem(`titles_${k}`) || "[]"); }
        function savePersistedData() { if(!userAddr) return; const k = userAddr.toLowerCase(); localStorage.setItem(`bonus_${k}`, localRepBonus); localStorage.setItem(`titles_${k}`, JSON.stringify(userTitles)); }
        window.filterPolls = () => { const q = document.getElementById("searchBar").value.toLowerCase(); document.querySelectorAll('#pollGrid .card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(q) ? 'block' : 'none'); };

        async function updateAuditTrend() {
            if(!chartInstance || !contract) return;
            try {
                const currentBlock = await provider.getBlockNumber();
                const [vE, pE] = await Promise.all([
                    contract.queryFilter("VoteCast", Math.max(DEPLOY_BLOCK, currentBlock - 5000)).catch(() => []),
                    contract.queryFilter("PollCreated", Math.max(DEPLOY_BLOCK, currentBlock - 5000)).catch(() => [])
                ]);
                chartInstance.data.datasets[0].data = [vE.length * 0.4, vE.length * 0.7, vE.length + pE.length];
                chartInstance.update();
            } catch(e) {}
        }
        function initChartFrame() { const ctx = document.getElementById('mainChart').getContext('2d'); if (chartInstance) chartInstance.destroy(); chartInstance = new Chart(ctx, { type: 'line', data: { labels: ['æ—¥å‰','æ˜¨æ—¥','ä»Šæ—¥'], datasets: [{ label: 'å…¨ç¶²æ²»ç†æ´»èºåº¦', data: [0, 0, 0], borderColor: '#6366f1', fill: true, tension: 0.4 }] }, options: { plugins: { legend: { labels: { color: '#fff' } } }, scales: { y: { ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } } } }); }

        window.onload = init;
    </script>
</body>

</html>
