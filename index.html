<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniGov | çµ‚æ¥µå»ä¸­å¿ƒåŒ–æ²»ç†å¹³å°</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --p: #6366f1;
            --p-dark: #4f46e5;
            --bg: #0b0f1a;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --text: #f8fafc;
            --muted: #94a3b8;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f1c40f;
        }

        * {
            box-sizing: border-box;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            background-image: radial-gradient(circle at 50% -20%, #1e1b4b 0%, var(--bg) 80%);
        }

        /* å°è¦½åˆ— */
        .nav {
            backdrop-filter: blur(12px);
            background: rgba(11, 15, 26, 0.8);
            padding: 15px 5%;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }

        .nav-brand {
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--p);
            cursor: pointer;
        }

        .net-badge {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 50px;
            background: var(--error);
            color: white;
            display: none;
        }

        .net-ok {
            background: var(--success);
        }

        .user-chip {
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 5px 15px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .avatar-nav {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--p);
            object-fit: cover;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px 100px;
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        /* éŠæˆ²åŒ–è¦–è¦ºå„ªåŒ– */
        .lvl-container {
            margin: 25px 0;
            text-align: left;
            background: rgba(255, 255, 255, 0.02);
            padding: 20px;
            border-radius: 15px;
        }

        .lvl-bar {
            width: 100%;
            height: 16px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--border);
            margin-top: 10px;
        }

        .lvl-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #10b981, #f1c40f);
            width: 0%;
            transition: 2s ease;
        }

        /* ç¨±è™Ÿæ”¶è—ç‰†æ¨£å¼ */
        .title-wall {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .title-badge {
            background: linear-gradient(135deg, var(--p), #818cf8);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 33. å¿ƒæƒ…åæ‡‰æŒ‰éˆ• */
        .sentiment-bar {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .sentiment-btn {
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            color: var(--text);
            font-size: 1.1rem;
        }

        .sentiment-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        /* è½‰ç›¤è¦–è¦º */
        .wheel-wrap {
            position: relative;
            width: 340px;
            height: 340px;
            margin: 40px auto;
        }

        #wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 10px solid #1e293b;
            background: conic-gradient(#6366f1 0deg 72deg, #ec4899 72deg 144deg, #06b6d4 144deg 216deg, #f1c40f 216deg 288deg, #10b981 288deg 360deg);
            transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1);
        }

        .wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid var(--error);
            z-index: 10;
        }

        button {
            background: var(--p);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-danger {
            background: var(--error);
        }

        label {
            display: block;
            margin-top: 15px;
            color: var(--muted);
            font-size: 0.9rem;
            font-weight: 600;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: #fff;
            border-radius: 10px;
            margin: 8px 0;
            outline: none;
        }

        #toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: #1e293b;
            border-left: 4px solid var(--p);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        #log {
            background: #000;
            color: #10b981;
            font-family: monospace;
            padding: 20px;
            border-radius: 15px;
            height: 220px;
            overflow-y: auto;
            font-size: 13px;
            border: 1px solid var(--border);
            line-height: 1.6;
        }
    </style>
</head>

<body>

    <nav class="nav">
        <div class="nav-brand" onclick="showPage('guidePage')"><i class="fa-solid fa-atom"></i> UniGov</div>
        <div id="netStatus" class="net-badge">æœªé€£æ¥ Sepolia æ¸¬è©¦ç¶²</div>
        <div style="display:flex; gap:10px;">
            <button class="btn-ghost" onclick="showPage('guidePage')">å¤§å»³å¼•å°</button>
            <button class="btn-ghost" onclick="showPage('listPage')">æ²»ç†å¤§å»³</button>
            <button class="btn-ghost" onclick="showPage('modeInfoPage')">æ¨¡å¼ç™¾ç§‘</button>
            <button class="btn-ghost" onclick="showPage('statPage')">å¯©è¨ˆ/æ’è¡Œ</button>
            <button class="btn-ghost" onclick="showPage('wheelPage')">å¹¸é‹è½‰ç›¤</button>
        </div>
        <div id="userSection" style="margin-left:auto; display:flex; align-items:center; gap:15px;">
            <div id="userInfo" class="user-chip" style="display:none" onclick="showPage('profilePage')">
                <img id="navAvatar" src="" class="avatar-nav">
                <span id="navName">...</span>
                <span id="navRep" style="color:var(--warning); font-weight:bold;">Rep: 0</span>
            </div>
            <button id="connBtn" onclick="init()"><i class="fa-solid fa-wallet"></i> é€£æ¥éŒ¢åŒ…</button>
            <button id="discoBtn" class="btn-ghost" style="display:none" onclick="disconnectWallet()"><i
                    class="fa-solid fa-right-from-bracket"></i></button>
            <button onclick="showPage('createPage')"><i class="fa-solid fa-plus"></i> ç™¼èµ·ææ¡ˆ</button>
        </div>
    </nav>

    <div class="container">

        <div id="guidePage" class="page active">
            <div class="card" style="text-align:center; padding:80px 40px;">
                <h1 style="font-size:3.5rem; margin-bottom:20px;">æ­¡è¿ä¾†åˆ° UniGov æ²»ç†ä¸­å¿ƒ</h1>
                <p style="color:var(--muted); font-size:1.3rem; max-width:850px; margin:0 auto 50px;">
                    é€™æ˜¯ 2026 å¹´é ˜å…ˆçš„å»ä¸­å¿ƒåŒ–æ²»ç†å¹³å°ã€‚çµåˆ Web3 æŠ•ç¥¨ã€ç¤¾ç¾¤é æ¸¬å¸‚å ´èˆ‡å¿ƒæƒ…åæ‡‰æ©Ÿåˆ¶ã€‚
                </p>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:30px;">
                    <div class="card">
                        <i class="fa-solid fa-brain fa-3x" style="color:var(--p); margin-bottom:20px;"></i>
                        <h3>æ²»ç†é è¨€æ©Ÿ</h3>
                        <p>åƒèˆ‡é æ¸¬å¸‚å ´ï¼Œç²¾æº–æŠ¼æ³¨è­°æ¡ˆçµæœï¼Œç²å–é«˜é¡ç©åˆ†åŠ æˆã€‚</p>
                    </div>
                    <div class="card">
                        <i class="fa-solid fa-face-smile fa-3x" style="color:var(--success); margin-bottom:20px;"></i>
                        <h3>ç¤¾ç¾¤æ°£å€™</h3>
                        <p>é€é Emoji åæ˜ å°è­°æ¡ˆçš„çœŸå¯¦æ„Ÿå—ï¼Œè¦–è¦ºåŒ–ç¤¾ç¾¤æƒ…ç·’å…±è­˜ã€‚</p>
                    </div>
                    <div class="card">
                        <i class="fa-solid fa-database fa-3x" style="color:var(--warning); margin-bottom:20px;"></i>
                        <h3>æˆå°±æŒä¹…åŒ–</h3>
                        <p>æ‚¨çš„Repã€ç­‰ç´šèˆ‡æ”¶è—ç¨±è™Ÿå°‡æ°¸ä¹…ä¿å­˜åœ¨ç€è¦½å™¨èˆ‡éˆä¸Šã€‚</p>
                    </div>
                </div>
                <button style="margin:50px auto; padding:18px 50px; font-size:1.2rem;"
                    onclick="showPage('listPage')">é–‹å§‹å…±è­˜æ²»ç†</button>
            </div>
        </div>

        <div id="listPage" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <h1>éˆä¸Šæ²»ç†è­°æ¡ˆä¸­å¿ƒ</h1>
                <input type="text" id="searchBar" onkeyup="filterPolls()" placeholder="æœå°‹æ¨™é¡Œã€UID æˆ–åœ°å€..."
                    style="width:300px; margin:0;">
            </div>
            <div id="pollGrid"
                style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:24px;"></div>
        </div>

        <div id="modeInfoPage" class="page">
            <h1>æ²»ç†æ¨¡å¼ç™¾ç§‘å…¨æ›¸</h1>
            <div style="display:grid; gap:25px;">
                <div class="card">
                    <h2 style="color:var(--success)">ä¸€èˆ¬æ¨¡å¼ (Standard)</h2>
                    <p>åŸºç¤çš„ä¸€äººä¸€ç¥¨æ©Ÿåˆ¶ã€‚æ¯å€‹åˆæ ¼åœ°å€æ¬Šé‡ç›¸åŒï¼Œé©åˆç°¡å–®æ±ºç­–ã€‚</p>
                </div>
                <div class="card">
                    <h2 style="color:var(--p)">å¹³æ–¹æŠ•ç¥¨ (Quadratic Voting)</h2>
                    <p>å…¬å¼ï¼š$æˆæœ¬ = ç¥¨æ•¸^2$ã€‚è®“ä½¿ç”¨è€…èƒ½é‡å°åœ¨ä¹çš„è­°é¡Œè¡¨é”å¼·åº¦ã€‚</p>
                </div>
                <div class="card">
                    <h2 style="color:var(--success)">å¹³æ–¹å‹Ÿè³‡ (Quadratic Funding)</h2>
                    <p>æ ¸å¿ƒç†å¿µï¼šã€Œäººæ•¸æ¯”é‡‘é¡é‡è¦ã€ã€‚å¸¸ç”¨æ–¼åˆ†é…å…¬å…±è²¡è³‡åŠ©é‡‘ã€‚</p>
                </div>
                <div class="card">
                    <h2 style="color:var(--warning)">åå¥½æ’åº (Ranked Choice)</h2>
                    <p>æŠ•ç¥¨è€…å°å€™é¸äººé€²è¡Œæ’åºã€‚è‹¥é¦–é¸è¢«æ·˜æ±°ï¼Œç¥¨æ¬Šè‡ªå‹•è½‰ç§»è‡³æ¬¡é¸ã€‚</p>
                </div>
                <div class="card">
                    <h2 style="color:var(--error)">æ¬Šé‡æŠ•ç¥¨ (Weighted Voting)</h2>
                    <p>è©±èªæ¬Šå–æ±ºæ–¼æŒæœ‰çš„ä»£å¹£æ•¸é‡ã€‚æŒæœ‰è¶Šå¤šï¼Œåœ¨æ²»ç†ä¸­çš„å½±éŸ¿åŠ›è¶Šå¤§ã€‚</p>
                </div>
            </div>
        </div>

        <div id="profilePage" class="page">
            <div class="card" style="max-width:650px; margin:0 auto; text-align:center">
                <h2>æ²»ç†èº«åˆ†é¢æ¿ (Identity)</h2>
                <img id="profileAvatar" src=""
                    style="width:140px; height:140px; border-radius:50%; border:4px solid var(--p); margin: 20px 0; object-fit:cover;">

                <div class="lvl-container">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <b id="lvlTitle" style="color:var(--warning)">è¼‰å…¥ä¸­...</b>
                        <span id="repStatus">Rep: 0 / 100</span>
                    </div>
                    <div class="lvl-bar">
                        <div id="lvlFill" class="lvl-fill"></div>
                    </div>
                    <small id="lvlHint" style="color:var(--muted); margin-top:5px; display:block;">å†ç²å¾—ä¸€äº› Rep
                        å³å¯å‡ç´š</small>
                </div>

                <div style="margin-top:20px; border:1px dashed var(--border); padding:20px; border-radius:20px;">
                    <h4><i class="fa-solid fa-trophy"></i> ç¨±è™Ÿæˆå°±æ”¶è—å®¤</h4>
                    <div id="titleCollection" class="title-wall">
                        <span style="color:var(--muted); font-size:0.9rem;">å°šæœªç²å¾—ä»»ä½•ç¨±è™Ÿ...</span>
                    </div>
                </div>

                <div style="display:flex; gap:15px; margin:30px 0;">
                    <button id="checkInBtn" onclick="handleDailyCheckIn()"
                        style="flex:1; background:var(--success); height:55px;">
                        <i class="fa-solid fa-calendar-check"></i> æ¯æ—¥ç°½åˆ° (+10 Rep)
                    </button>
                    <button onclick="saveProfile()" style="flex:1; height:55px;">æ›´æ–°æ²»ç†è³‡æ–™</button>
                </div>

                <div style="text-align:left; background:rgba(0,0,0,0.2); padding:25px; border-radius:20px;">
                    <label>æš±ç¨±</label><input type="text" id="editName">
                    <label>é ­åƒ IPFS CID</label><input type="text" id="editAvatar">
                </div>
                <button class="btn-danger" style="width:100%; margin-top:30px;"
                    onclick="disconnectWallet()">æ–·é–‹éŒ¢åŒ…</button>
            </div>
        </div>

        <div id="statPage" class="page">
            <div style="display:grid; grid-template-columns: 1.6fr 1fr; gap:30px;">
                <div>
                    <h1>å…¨ç¶²æ²»ç†å¯©è¨ˆ</h1>
                    <div class="card"><canvas id="mainChart"></canvas></div>
                    <div id="log">æ­£åœ¨ç›£è½ Sepolia éˆä¸Šäº‹ä»¶...</div>
                </div>
                <div>
                    <h1>é ˜è¢–æ’è¡Œæ¦œ</h1>
                    <div class="card" id="leaderboardList"></div>
                    <div class="card" style="text-align:center">
                        <h4>æ²»ç†å¥åº·æŒ‡æ¨™</h4>
                        <h2 style="color:var(--success); font-size:2.5rem;">98.5%</h2>
                    </div>
                </div>
            </div>
        </div>

        <div id="wheelPage" class="page" style="text-align:center">
            <h1>å¹¸é‹æ²»ç†è½‰ç›¤</h1>
            <p style="color:var(--muted)">æ¯æ—¥å¯æŠ½é¸ç¨±è™Ÿæˆ–æ²»ç†é‹å‹¢ï¼</p>
            <div class="wheel-wrap">
                <div class="wheel-pointer"></div>
                <div id="wheel"></div>
            </div>
            <button id="spinBtn" style="margin:30px auto; padding:15px 45px; font-size:1.2rem;" onclick="spinWheel()">
                å•Ÿå‹•æ˜Ÿè¾°åŠ›é‡
            </button>
            <h2 id="wheelResult" style="margin-top:20px; color:var(--p); font-size:2rem;"></h2>
        </div>

        <div id="createPage" class="page">
            <div class="card" style="max-width:750px; margin:0 auto">
                <h2>ç™¼èµ·æ–°è­°æ¡ˆ (Create Proposal)</h2>

                <label>è­°æ¡ˆæ¨™é¡Œ</label>
                <input type="text" id="topic" placeholder="ä¾‹å¦‚ï¼š2026 å¹´åº¦ç¤¾ç¾¤ç™¼å±•è³‡é‡‘åˆ†é…æ–¹æ¡ˆ">

                <label>é¸æ“‡æŠ•ç¥¨æ¨¡å¼</label>
                <select id="modeSelect" onchange="toggleModeFields()">
                    <option value="0">ä¸€èˆ¬æ¨¡å¼ (Standard)</option>
                    <option value="1">å¹³æ–¹æŠ•ç¥¨ (Quadratic Voting)</option>
                    <option value="2">å¹³æ–¹å‹Ÿè³‡ (Quadratic Funding)</option>
                    <option value="3">åå¥½æ’åº (Ranked Choice)</option>
                    <option value="4">æ¬Šé‡æŠ•ç¥¨ (Weighted Voting)</option>
                </select>

                <div id="setup-qv" class="mode-section">
                    <h4>å¹³æ–¹æŠ•ç¥¨è¨­å®š</h4>
                    <label>æ¯ä½åƒèˆ‡è€…ç™¼æ”¾çš„åˆå§‹é»æ•¸ (Voice Credits)</label>
                    <input type="number" id="qv-credits" value="100">
                </div>

                <div id="setup-qf" class="mode-section">
                    <h4>å¹³æ–¹å‹Ÿè³‡è¨­å®š</h4>
                    <label>é…å°è³‡é‡‘æ± ç¸½é¡ (Matching Pool USDC)</label>
                    <input type="number" id="qf-pool" value="1000">
                </div>

                <label>å€™é¸äººåç¨± (é€—è™Ÿéš”é–‹)</label>
                <input type="text" id="names" placeholder="é …ç›® A, é …ç›® B">
                <label>å€™é¸äºº UID (ç•™ç©ºè‡ªå‹•ç”Ÿæˆ)</label>
                <input type="text" id="uids" placeholder="ID-001">
                <label>æŒçºŒæ™‚é–“ (åˆ†é˜)</label>
                <input type="number" id="duration" value="60">

                <button onclick="handleCreatePoll()" style="width:100%; margin-top:30px; height:60px;">éƒ¨ç½²è‡³
                    Sepolia</button>
            </div>
        </div>

        <div id="detailPage" class="page">
            <div id="pollInfo" class="card" style="border-left: 8px solid var(--p);"></div>

            <div class="card" style="text-align:center">
                <h4>æ‚¨å°æ­¤æ¡ˆçš„ã€Œé«”æ„Ÿæº«åº¦ã€ï¼Ÿ</h4>
                <div class="sentiment-bar">
                    <div class="sentiment-btn" onclick="notify('æ‚¨æŠ•ä¸‹äº† ğŸ”¥ ç†±è¡€ä¸€ç¥¨ï¼','success')">ğŸ”¥ ç†±è¡€</div>
                    <div class="sentiment-btn" onclick="notify('æ‚¨è¡¨ç¤º ğŸ¤” æ­£åœ¨è§€æœ›...','info')">ğŸ¤” æ‡·ç–‘</div>
                    <div class="sentiment-btn" onclick="notify('æ‚¨èªç‚º ğŸš€ å‹¢åœ¨å¿…è¡Œï¼','success')">ğŸš€ çœ‹å¥½</div>
                    <div class="sentiment-btn" onclick="notify('æ‚¨æ„Ÿåˆ° ğŸ’¤ ä¹äººå•æ´¥ã€‚','error')">ğŸ’¤ æ²’å‹</div>
                </div>
            </div>

            <div class="card" style="border: 2px solid var(--p); background: rgba(99, 102, 241, 0.05);">
                <h3><i class="fa-solid fa-crystal-ball"></i> æ²»ç†é è¨€æ©Ÿ (Oracle)</h3>
                <p>æŠ¼æ³¨å“ªå€‹å€™é¸äººå°‡å‹å‡ºï¼ŸçŒœå°å¯ç²å¾— +20 Repï¼</p>
                <div style="display:flex; gap:10px;">
                    <select id="oracleGuess">
                        <option>å€™é¸äºº 1</option>
                        <option>å€™é¸äºº 2</option>
                    </select>
                    <button onclick="notify('é æ¸¬æˆåŠŸï¼æ‚¨çš„æŠ¼æ³¨å·²è¨˜éŒ„ã€‚','success')">ç¢ºèªé æ¸¬</button>
                </div>
            </div>

            <div id="votingUI" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;"></div>
        </div>

    </div>

    <div id="toast-container"></div>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const CONTRACT_ADDR = "0xc438c3f6131030Ac5e7070FFFe7434559a9cdd3b";
        const ABI = [
            { "inputs": [{ "internalType": "uint256", "name": "_pid", "type": "uint256" }, { "internalType": "uint256", "name": "_cid", "type": "uint256" }, { "internalType": "uint256", "name": "_val", "type": "uint256" }], "name": "castVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "string", "name": "_t", "type": "string" }, { "internalType": "enum UniGov.VotingMode", "name": "_m", "type": "uint8" }, { "internalType": "string[]", "name": "_n", "type": "string[]" }, { "internalType": "string[]", "name": "_u", "type": "string[]" }, { "internalType": "uint256", "name": "_d", "type": "uint256" }], "name": "createPoll", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_pid", "type": "uint256" }, { "internalType": "string", "name": "_newTopic", "type": "string" }, { "internalType": "string[]", "name": "_newNames", "type": "string[]" }, { "internalType": "string[]", "name": "_newUids", "type": "string[]" }], "name": "updatePollMetadata", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "uint256", "name": "pollId", "type": "uint256" }, { "indexed": false, "internalType": "string", "name": "topic", "type": "string" }, { "indexed": false, "internalType": "uint8", "name": "mode", "type": "uint8" }, { "indexed": false, "internalType": "address", "name": "creator", "type": "address" }], "name": "PollCreated", "type": "event" }
        ];

        let provider, signer, userAddr, userRep = 0, userTitles = [];

        // --- è³‡æ–™æŒä¹…åŒ– ---
        function loadData() {
            const r = localStorage.getItem('unigov_rep');
            const t = localStorage.getItem('unigov_titles');
            if (r) userRep = parseInt(r);
            if (t) userTitles = JSON.parse(t);
        }
        function saveData() {
            localStorage.setItem('unigov_rep', userRep);
            localStorage.setItem('unigov_titles', JSON.stringify(userTitles));
        }

        async function init() {
            if (!window.ethereum) return notify("è«‹å®‰è£éŒ¢åŒ…", "error");
            provider = new ethers.providers.Web3Provider(window.ethereum);
            try {
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111) await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: "0xaa36a7" }] });
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddr = await signer.getAddress();
                loadData(); updateUI(); renderPolls(); renderLeaderboard();
                notify("Web3 é€£ç·šæˆåŠŸ", "success");
            } catch (e) { notify("æ“ä½œå–æ¶ˆ", "error"); }
        }

        function updateUI() {
            if (!userAddr) return;
            document.getElementById("userInfo").style.display = "flex";
            document.getElementById("connBtn").style.display = "none";
            document.getElementById("discoBtn").style.display = "block";
            document.getElementById("navName").innerText = userAddr.substring(0, 6) + "...";
            document.getElementById("navAvatar").src = `https://api.dicebear.com/7.x/identicon/svg?seed=${userAddr}`;
            document.getElementById("profileAvatar").src = `https://api.dicebear.com/7.x/identicon/svg?seed=${userAddr}`;
            document.getElementById("navRep").innerText = "Rep: " + userRep;

            // ç­‰ç´šåˆ¤æ–·
            let lvl = "ğŸŒ± æ²»ç†èŒèŠ½"; let next = 50; let fill = (userRep / 50) * 100;
            if (userRep > 50) { lvl = "ğŸ›¡ï¸ æ²»ç†åŸ·æ³•è€…"; next = 150; fill = ((userRep - 50) / 100) * 100; }
            if (userRep > 150) { lvl = "ğŸ‘‘ æ²»ç†å‚³å¥‡"; next = 500; fill = ((userRep - 150) / 350) * 100; }

            document.getElementById("lvlTitle").innerText = "ç­‰ç´šï¼š" + lvl;
            document.getElementById("lvlFill").style.width = Math.min(fill, 100) + "%";
            document.getElementById("repStatus").innerText = `Rep: ${userRep} / ${next}`;

            const wall = document.getElementById("titleCollection");
            if (userTitles.length > 0) wall.innerHTML = userTitles.map(t => `<span class="title-badge">${t}</span>`).join('');
            saveData();
        }

        function handleDailyCheckIn() {
            userRep += 10; notify("ç°½åˆ°æˆåŠŸï¼Rep +10", "success"); updateUI(); confetti({ particleCount: 150 });
        }

        function spinWheel() {
            const deg = 1800 + Math.random() * 1800;
            document.getElementById("wheel").style.transform = `rotate(${deg}deg)`;
            const prizes = [
                { t: "ç¨±è™Ÿï¼šæ²»ç†å°åšå£«", v: "æ²»ç†å°åšå£«" }, { t: "ç¨±è™Ÿï¼šæ­£ç¾©ä¹‹ç›¾", v: "æ­£ç¾©ä¹‹ç›¾" },
                { t: "é‹å‹¢ï¼šä¸Šä¸Šç±¤", v: null }, { t: "ç¨±è™Ÿï¼šå…±è­˜å¤§å¸«", v: "å…±è­˜å¤§å¸«" }
            ];
            notify("æŠ½å–é‹å‹¢ä¸­...", "info");
            setTimeout(() => {
                const res = prizes[Math.floor(Math.random() * prizes.length)];
                document.getElementById("wheelResult").innerText = res.t;
                if (res.v && !userTitles.includes(res.v)) { userTitles.push(res.v); updateUI(); }
                confetti();
            }, 4000);
        }

        function disconnectWallet() { userAddr = null; location.reload(); }

        function generateUID() { return 'CAND-' + Math.random().toString(36).substr(2, 5).toUpperCase() + '-' + Date.now().toString().slice(-4); }

        function toggleModeFields() {
            const m = document.getElementById("modeSelect").value;
            document.getElementById("setup-qv").style.display = m == "1" ? 'block' : 'none';
            document.getElementById("setup-qf").style.display = m == "2" ? 'block' : 'none';
        }

        function handleCreatePoll() {
            const n = document.getElementById("names").value.split(",");
            const u = document.getElementById("uids").value.split(",");
            const finalUids = n.map((name, i) => u[i] && u[i].trim() !== "" ? u[i].trim() : generateUID());
            notify("UID å·²è£œå…¨ï¼Œæ­£åœ¨æ‰“åŒ… Sepolia äº¤æ˜“...", "info");
            setTimeout(() => { confetti(); showPage('listPage'); }, 1500);
        }

        function renderPolls() {
            document.getElementById("pollGrid").innerHTML = `<div class="card" onclick="viewDetail(101)"><h3>#101 2026å¹´åº¦æ²»ç†å”è­°å‡ç´šæ¡ˆ</h3><p style="color:var(--p)">æ¨¡å¼ï¼šå¹³æ–¹æŠ•ç¥¨ (QV)</p></div>`;
        }

        function viewDetail(id) {
            showPage('detailPage');
            const poll = { topic: "2026å¹´åº¦æ²»ç†å”è­°å‡ç´šæ¡ˆ", creator: userAddr, totalVotes: 0 };
            document.getElementById("pollInfo").innerHTML = `<h1>${poll.topic}</h1><p>ç™¼èµ·äººï¼š${poll.creator}</p>`;
            document.getElementById("votingUI").innerHTML = `<div class="card" style="text-align:center"><h3>æ–¹æ¡ˆä¸€ï¼šåŸºç¤æ“´å±•</h3><button onclick="notify('äº¤æ˜“è™•ç†ä¸­','info')">æŠ•ä¸‹ä¸€ç¥¨</button></div>`;
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id == 'statPage') initChart();
            window.scrollTo(0, 0);
        }

        function notify(m, t) {
            const c = document.getElementById("toast-container");
            const div = document.createElement("div"); div.className = "toast";
            div.style.borderLeftColor = t == 'error' ? 'var(--error)' : 'var(--p)';
            div.innerText = m; c.appendChild(div); setTimeout(() => div.remove(), 4000);
        }

        function renderLeaderboard() {
            const list = document.getElementById("leaderboardList");
            const data = [{ a: "0x71...2B", r: 550 }, { a: "0x88...F1", r: 420 }, { a: "0x32...A9", r: 310 }];
            list.innerHTML = data.map((p, i) => `<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border)"><span>${i + 1}. ${p.a}</span><b>${p.r} Rep</b></div>`).join('');
        }

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            new Chart(ctx, { type: 'line', data: { labels: ['1æœˆ', '2æœˆ', '3æœˆ'], datasets: [{ label: 'å…¨ç¶²ç¥¨æ•¸', data: [120, 310, 450], borderColor: '#6366f1' }] } });
        }

        function filterPolls() {
            const q = document.getElementById("searchBar").value.toLowerCase();
            document.querySelectorAll('#pollGrid .card').forEach(c => {
                c.style.display = c.innerText.toLowerCase().includes(q) ? 'block' : 'none';
            });
        }

        window.onload = () => { if (window.ethereum) console.log("UniGov System Online"); };
    </script>
</body>

</html>