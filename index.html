<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniGov | çµ‚æ¥µå»ä¸­å¿ƒåŒ–æ²»ç†å¹³å°</title>

    <!-- å¤–éƒ¨åº«è¼‰å…¥ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK (åƒ…ä½œç‚ºåœ°å€ç™¼ç¾èˆ‡è¨ˆç®—çµæœå¿«å–ï¼Œä¸ç•¶æ¬Šå¨) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'unigov-v1';

        window.govDB = { db, auth, collection, doc, setDoc, getDocs, onSnapshot, appId, signInAnonymously };
    </script>

    <style>
        :root {
            --p: #6366f1; --p-dark: #4f46e5; --bg: #0b0f1a; --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1); --text: #f8fafc; --muted: #94a3b8;
            --success: #10b981; --error: #ef4444; --warning: #f1c40f;
        }

        * { box-sizing: border-box; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; min-height: 100vh; background-image: radial-gradient(circle at 50% -20%, #1e1b4b 0%, var(--bg) 80%);
        }

        /* å°è¦½åˆ— */
        .nav {
            backdrop-filter: blur(12px); background: rgba(11, 15, 26, 0.8);
            padding: 15px 5%; display: flex; align-items: center; gap: 15px;
            position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border);
        }
        .nav-brand { font-weight: 800; font-size: 1.5rem; color: var(--p); cursor: pointer; }
        .net-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 50px; background: var(--error); color: white; }
        .net-ok { background: var(--success); }

        .user-chip { background: var(--glass); border: 1px solid var(--border); padding: 5px 15px; border-radius: 50px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar-nav { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--p); object-fit: cover; }

        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px 100px; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--glass); border: 1px solid var(--border); border-radius: 24px; padding: 30px; margin-bottom: 20px; position: relative; overflow: hidden; }

        .lvl-container { margin: 25px 0; text-align: left; background: rgba(255,255,255,0.02); padding: 20px; border-radius: 15px; }
        .lvl-bar { width: 100%; height: 16px; background: rgba(0, 0, 0, 0.4); border-radius: 20px; overflow: hidden; border: 1px solid var(--border); margin-top: 10px; }
        .lvl-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #10b981, #f1c40f); width: 0%; transition: 2s ease; }
        .title-badge { background: linear-gradient(135deg, var(--p), #818cf8); color: white; padding: 8px 16px; border-radius: 50px; font-size: 0.85rem; font-weight: 600; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }

        .cand-img-wrap { width: 180px; height: 180px; overflow: hidden; border-radius: 50%; margin: 0 auto 20px; background: #111; border: 4px solid var(--p); box-shadow: 0 10px 40px rgba(99, 102, 241, 0.2); position: relative; display: flex; align-items: center; justify-content: center; }
        .cand-img { width: 100%; height: 100%; object-fit: cover; }

        .task-list { display: grid; gap: 12px; margin-top: 20px; text-align: left; }
        .task-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
        .task-done { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }

        button { background: var(--p); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 8px; justify-content: center; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3); }

        #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #1e293b; border-left: 4px solid var(--p); color: white; padding: 15px 25px; border-radius: 8px; animation: slideIn 0.3s ease; }

        .leader-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid var(--border); }
        .leader-rank { width: 35px; font-weight: 800; color: var(--p); }
        .leader-addr { flex: 1; font-family: monospace; font-size: 0.85rem; margin-left: 10px; color: var(--success); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .leader-rep { color: var(--warning); font-weight: bold; }
        .me-tag { background: var(--p); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

        .scanning-bar { padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 15px; font-size: 0.85rem; margin-bottom: 15px; text-align: center; border: 1px dashed var(--p); color: var(--text); }
        .sentiment-bar { display: flex; gap: 15px; justify-content: center; margin: 20px 0; }
        .sentiment-btn { background: var(--glass); border: 1px solid var(--border); padding: 10px 20px; border-radius: 50px; cursor: pointer; color: var(--text); }
        
        .wheel-wrap { position: relative; width: 340px; height: 340px; margin: 40px auto; }
        #wheel { width: 100%; height: 100%; border-radius: 50%; border: 10px solid #1e293b; background: conic-gradient(#6366f1 0deg 72deg, #ec4899 72deg 144deg, #06b6d4 144deg 216deg, #f1c40f 216deg 288deg, #10b981 288deg 360deg); transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1); box-shadow: 0 0 50px rgba(99, 102, 241, 0.3); }
        .wheel-pointer { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid var(--error); z-index: 10; }
    </style>
</head>

<body>

    <nav class="nav">
        <div class="nav-brand" onclick="showPage('guidePage')"><i class="fa-solid fa-atom"></i> UniGov</div>
        <div id="netStatus" class="net-badge">æ­£åœ¨åµæ¸¬...</div>
        <div style="display:flex; gap:10px;">
            <button class="btn-ghost" onclick="showPage('guidePage')">å¼•å°</button>
            <button class="btn-ghost" onclick="showPage('listPage')">å¤§å»³</button>
            <button class="btn-ghost" onclick="showPage('modeInfoPage')">ç™¾ç§‘</button>
            <button class="btn-ghost" onclick="showPage('statPage')">å¯©è¨ˆ/æ’è¡Œ</button>
            <button class="btn-ghost" onclick="showPage('wheelPage')">è½‰ç›¤</button>
        </div>
        <div id="userSection" style="margin-left:auto; display:flex; align-items:center; gap:15px;">
            <div id="userInfo" class="user-chip" style="display:none" onclick="showPage('profilePage')">
                <img id="navAvatar" src="" class="avatar-nav">
                <span id="navName">...</span>
                <span id="navRep" style="color:var(--warning); font-weight:bold;">Rep: 0</span>
            </div>
            <button id="connBtn" onclick="connectWalletFlow()"><i class="fa-solid fa-wallet"></i> é€£æ¥éŒ¢åŒ…</button>
            <button id="discoBtn" class="btn-ghost" style="display:none" onclick="disconnectWallet()"><i class="fa-solid fa-right-from-bracket"></i></button>
            <button onclick="showPage('createPage')"><i class="fa-solid fa-plus"></i> ææ¡ˆ</button>
        </div>
    </nav>

    <div class="container">

        <!-- 1. å¼•å°é é¢ (å…¨åŠŸèƒ½ä¸åˆªæ¸›) -->
        <div id="guidePage" class="page active">
            <div class="card" style="text-align:center; padding:80px 40px;">
                <h1>UniGov æ²»ç†ç”Ÿæ…‹å¤§å»³</h1>
                <p style="color:var(--muted); font-size:1.2rem;">æ•´åˆèº«åˆ†ä¸»æ¬Šã€å¤šç¶­å…±è­˜èˆ‡æ¦®è­½é¤Šæˆã€‚æ‰€æœ‰æ’è¡Œæ¦œæ•¸æ“šçš†ç‚ºã€Œéˆä¸Šæ¬Šå¨ Repã€ã€‚</p>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:30px; margin-top:40px;">
                    <div class="card"><h3>éˆä¸Šèº«åˆ†</h3><p>è¨»å†Šå¾Œæ‚¨çš„è²¢ç»å°‡é‡åŒ–ç‚ºè²è­½ (Rep)ï¼Œé€™æ˜¯å…¨ç¶²å…¬èªçš„æ¬ŠåŠ›é‡é‡ã€‚</p></div>
                    <div class="card"><h3>äº”å¤§å…±è­˜å¼•æ“</h3><p>å…§å»ºä¸€èˆ¬ã€å¹³æ–¹ã€æ’åºç­‰äº”å¤§æ°‘ä¸»æ¨¡å‹ï¼Œç²¾æº–å°æŠ—æ²»ç†å£Ÿæ–·ã€‚</p></div>
                    <div class="card"><h3>æ¦®è­½å­˜è­‰ç‰†</h3><p>æ²»ç†ç²å–çš„ç¨±è™Ÿèˆ‡ç­‰ç´šå°‡æ°¸ä¹…éš¨ä½å€ä¿å­˜ï¼Œä¸å› è¨­å‚™æ›´æ›è€Œéºå¤±ã€‚</p></div>
                </div>
                <button style="margin:40px auto; padding:18px 50px;" onclick="showPage('listPage')">é–‹å•Ÿå…±è­˜ä¹‹æ—…</button>
            </div>
        </div>

        <!-- 2. å¤§å»³é é¢ -->
        <div id="listPage" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <h1>æ²»ç†è­°æ¡ˆä¸­å¿ƒ</h1>
                <input type="text" id="searchBar" onkeyup="filterPolls()" placeholder="æœå°‹é—œéµå­—..." style="width:250px;">
            </div>
            <div id="pollGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:20px;"></div>
        </div>

        <!-- 3. æ•¸æ“šçœ‹æ¿ (éˆä¸Š Rep æ’è¡Œæ¦œ + äº‹ä»¶è¶¨å‹¢åœ–) -->
        <div id="statPage" class="page">
            <div style="display:grid; grid-template-columns: 1.6fr 1fr; gap:30px;">
                <div>
                    <h1>æ²»ç†å¯©è¨ˆè¶¨å‹¢åœ– (çœŸå¯¦äº‹ä»¶ç´¯è¨ˆ)</h1>
                    <div class="card"><canvas id="mainChart" height="200"></canvas></div>
                    <div id="log">> ç³»çµ±ç‹€æ…‹ï¼šæ­£åœ¨ç›£è½éˆä¸Š VoteCast èˆ‡ PollCreated äº‹ä»¶...</div>
                </div>
                <div>
                    <h1>å…¨ç¶²é ˜è¢–æ’è¡Œ <small style="font-size:0.6rem; color:var(--muted)">(éˆä¸ŠçœŸå¯¦ Rep Only)</small></h1>
                    <div id="leaderboardList" class="card" style="padding:0; min-height: 400px; display:flex; flex-direction:column;">
                        <div id="leaderScanStatus" class="scanning-bar" onclick="renderLeaderboard()"><i class="fa-solid fa-satellite-dish fa-spin"></i> åŒæ­¥å…¨éˆçœŸå¯¦æ•¸æ“šä¸­... (é»æ“Šåˆ·æ–°)</div>
                        <div id="leaderContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. å¹¸é‹è½‰ç›¤ -->
        <div id="wheelPage" class="page" style="text-align:center">
            <h1>æ²»ç†é‹å‹¢è½‰ç›¤</h1>
            <div class="wheel-wrap"><div class="wheel-pointer"></div><div id="wheel"></div></div>
            <button style="margin:30px auto;" onclick="spinWheel()">å•Ÿå‹•è½‰ç›¤</button>
            <h2 id="wheelResult" style="color:var(--warning); min-height:40px;"></h2>
        </div>

        <!-- 5. ç™¾ç§‘é é¢ (äº”å¤§æ¨¡å¼å›æ­¸) -->
        <div id="modeInfoPage" class="page">
            <h1>æ²»ç†æ¨¡å¼ç™¾ç§‘å…¨æ›¸</h1>
            <div style="display:grid; gap:20px;">
                <div class="card"><h3>ä¸€èˆ¬æ¨¡å¼</h3><p>ä¸€äººä¸€ç¥¨ï¼Œæœ€ç´”ç²¹çš„åŸºæº–æ°‘ä¸»ã€‚</p></div>
                <div class="card"><h3>å¹³æ–¹æŠ•ç¥¨ (QV)</h3><p>ä¿è­·å°‘æ•¸æ´¾æ„è¦‹è¡¨é”å¼·åº¦ã€‚</p></div>
                <div class="card"><h3>å¹³æ–¹å‹Ÿè³‡ (QF)</h3><p>å„ªåŒ–å…¬å…±è³‡æºæ’¥æ¬¾åˆ†é…ã€‚</p></div>
                <div class="card"><h3>åå¥½æ’åº</h3><p>é¸å‡ºç¾¤é«”æ¥å—åº¦æœ€é«˜çš„å…¬ç´„æ•¸ã€‚</p></div>
                <div class="card"><h3>æ¬Šé‡æŠ•ç¥¨</h3><p>åŸºæ–¼ä»£å¹£æŒå€‰æ±ºå®šæ²»ç†æ¬Šã€‚</p></div>
            </div>
        </div>

        <!-- 6. å€‹äººé é¢ (å« localRepBonus æ¿€å‹µ) -->
        <div id="profilePage" class="page">
            <div class="card" style="max-width:650px; margin:0 auto; text-align:center">
                <h2>æ²»ç†è€…å„€è¡¨æ¿</h2>
                <div id="regAlert" style="background:rgba(239,68,68,0.1); border:1px solid var(--error); padding:15px; border-radius:15px; margin-bottom:20px; display:none;">
                    <b style="color:var(--error);">æ‚¨å°šæœªè¨»å†Šèº«åˆ†</b><br>
                    <button onclick="handleRegisterOnChain()" class="btn-danger" style="margin:10px auto;">åŸ·è¡Œéˆä¸Šè¨»å†Š</button>
                </div>
                <img id="profileAvatar" src="" style="width:140px; height:140px; border-radius:50%; border:4px solid var(--p); margin: 20px 0; object-fit:cover;">
                
                <div class="lvl-container">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <b id="lvlTitle" style="color:var(--warning)">è¼‰å…¥ä¸­...</b>
                        <span id="repStatus">è²æœ›ï¼š0</span>
                    </div>
                    <div class="lvl-bar"><div id="lvlFill" class="lvl-fill"></div></div>
                    <p style="font-size:0.75rem; color:var(--muted); margin-top:10px;">åŒ…å«éˆä¸Š Rep èˆ‡æœ¬åœ°ä»»å‹™åŠ æˆ (+<span id="bonusValue">0</span>)</p>
                </div>

                <div class="task-list">
                    <div class="task-item" id="task-daily">
                        <div style="flex:1"><b>æ¯æ—¥æ²»ç†ç°½åˆ°</b><br><small>é ˜å–æœ¬åœ°è²æœ›æ¿€å‹µ (+10)</small></div>
                        <button onclick="handleDailyCheckIn()" id="checkInBtn" class="btn-success">åŸ·è¡Œç°½åˆ°</button>
                    </div>
                </div>

                <div style="margin-top:20px; border:1px dashed var(--border); padding:20px; border-radius:20px;">
                    <h4><i class="fa-solid fa-trophy"></i> ç¨±è™Ÿæˆå°±æ”¶è—å®¤</h4>
                    <div id="titleCollection" class="title-wall"></div>
                </div>

                <button class="btn-danger" style="width:100%; margin-top:25px;" onclick="disconnectWallet()">æ–·é–‹é€£æ¥</button>
            </div>
        </div>

        <!-- 7. ç™¼èµ·ææ¡ˆé é¢ -->
        <div id="createPage" class="page">
            <div class="card" style="max-width:800px; margin:0 auto">
                <h2>éƒ¨ç½²æ–°æ²»ç†è­°æ¡ˆ</h2>
                <input type="text" id="topic" placeholder="ä¾‹ï¼šèª°æ˜¯å¹´åº¦æœ€ä½³é …ç›®ï¼Ÿ">
                <select id="modeSelect">
                    <option value="0">ä¸€èˆ¬æ¨¡å¼ (Standard)</option>
                    <option value="1">å¹³æ–¹æŠ•ç¥¨ (Quadratic)</option>
                    <option value="2">å¹³æ–¹å‹Ÿè³‡ (QF Matching)</option>
                    <option value="3">åå¥½æ’åº (Ranked Choice)</option>
                    <option value="4">æ¬Šé‡æŠ•ç¥¨ (Weighted Voting)</option>
                </select>
                <div id="candidateInputsContainer" style="margin-top:15px;"></div>
                <button class="btn-ghost" onclick="addCandidateInput()" style="width:100%; margin-top:10px;">æ–°å¢å€™é¸äºº</button>
                <button id="submitCreateBtn" onclick="handleCreatePoll()" style="width:100%; margin-top:30px; height:60px;">éƒ¨ç½²è‡³ Sepolia</button>
            </div>
        </div>

        <!-- 8. è©³æƒ…é é¢ (é è¨€æ©Ÿã€åæ‡‰ã€åˆªé™¤) -->
        <div id="detailPage" class="page">
            <button class="btn-ghost" onclick="showPage('listPage')" style="margin-bottom: 20px;"><i class="fa-solid fa-chevron-left"></i> è¿”å›åˆ—è¡¨</button>
            <div id="pollInfo" class="card" style="border-left: 8px solid var(--p);"></div>
            
            <div id="oracleSection" class="card" style="border: 2px solid var(--p);">
                <h3>æ²»ç†é è¨€æ©Ÿ (Oracle)</h3>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <select id="oracleGuess" style="flex:2; margin:0;"></select>
                    <button onclick="handleOracleBet()" class="btn-success" style="flex:1;">é æ¸¬å‹å‡ºè€…</button>
                </div>
            </div>

            <div id="creatorEditSection" class="card" style="display:none; border:2px solid var(--warning);">
                <h3 style="color:var(--warning);">ç™¼èµ·äººç·¨è¼¯é¢æ¿</h3>
                <input type="text" id="editTopic">
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="handleEditPollMetadata()" class="btn-success" style="flex:2;">åŒæ­¥éˆä¸Š</button>
                    <button onclick="handleDeletePoll()" class="btn-danger" style="flex:1;">åˆªé™¤</button>
                </div>
            </div>

            <div class="card" style="text-align:center">
                <div class="sentiment-bar">
                    <div class="sentiment-btn" onclick="notify('ç†±è¡€æŠ•ç¥¨ï¼','success')">ğŸ”¥</div>
                    <div class="sentiment-btn" onclick="notify('è§€æœ›ä¸­ã€‚','info')">ğŸ¤”</div>
                    <div class="sentiment-btn" onclick="notify('çœ‹å¥½æŠ•ç¥¨ï¼','success')">ğŸš€</div>
                </div>
            </div>
            <div id="votingUI" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;"></div>
        </div>

    </div>

    <div id="toast-container"></div>

    <script type="module">
        const CONTRACT_ADDR = "0xc438c3f6131030Ac5e7070FFFe7434559a9cdd3b"; 
        const DEPLOY_BLOCK = 7000000;
        const ABI = [
            { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "user", "type": "address" }, { "indexed": false, "internalType": "string", "name": "name", "type": "string" }], "name": "UserRegistered", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "pollId", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "creator", "type": "address" }], "name": "PollCreated", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "pollId", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "voter", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "candidateId", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "weight", "type": "uint256" }], "name": "VoteCast", "type": "event" },
            { "inputs": [{ "internalType": "uint256", "name": "_pid", "type": "uint256" }, { "internalType": "uint256", "name": "_cid", "type": "uint256" }, { "internalType": "uint256", "name": "_val", "type": "uint256" }], "name": "castVote", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "string", "name": "_t", "type": "string" }, { "internalType": "enum UniGov.VotingMode", "name": "_m", "type": "uint8" }, { "internalType": "string[]", "name": "_n", "type": "string[]" }, { "internalType": "string[]", "name": "_u", "type": "string[]" }, { "internalType": "uint256", "name": "_d", "type": "uint256" }], "name": "createPoll", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "getPollCount", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "allPolls", "outputs": [{ "internalType": "uint256", "name": "id", "type": "uint256" }, { "internalType": "address", "name": "creator", "type": "address" }, { "internalType": "string", "name": "topic", "type": "string" }, { "internalType": "enum UniGov.VotingMode", "name": "mode", "type": "uint8" }, { "internalType": "uint256", "name": "endTime", "type": "uint256" }, { "internalType": "bool", "name": "isActive", "type": "bool" }, { "internalType": "uint256", "name": "totalVotes", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_pid", "type": "uint256" }], "name": "getCandidates", "outputs": [{ "components": [{ "internalType": "string", "name": "name", "type": "string" }, { "internalType": "string", "name": "uid", "type": "string" }, { "internalType": "uint256", "name": "voteWeight", "type": "uint256" }], "internalType": "struct UniGov.Candidate[]", "name": "", "type": "tuple[]" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "_user", "type": "address" }], "name": "getUserDashboard", "outputs": [{ "internalType": "string", "name": "name", "type": "string" }, { "internalType": "uint256", "name": "reputation", "type": "uint256" }, { "internalType": "uint256", "name": "credits", "type": "uint256" }, { "internalType": "bool", "name": "isRegistered", "type": "bool" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "string", "name": "_name", "type": "string" }, { "internalType": "string", "name": "_avatar", "type": "string" }], "name": "register", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_pid", "type": "uint256" }, { "internalType": "string", "name": "_newTopic", "type": "string" }, { "internalType": "string[]", "name": "_newNames", "type": "string[]" }, { "internalType": "string[]", "name": "_newUids", "type": "string[]" }], "name": "updatePollMetadata", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
        ];

        let provider, signer, userAddr, contract, onChainRep = 0, userCredits = 0, userTitles = [], isRegisteredOnChain = false;
        let localRepBonus = 0, chartInstance = null, currentPid = null;

        // --- å…¨åŸŸä¿®å¾©ï¼šnotify èˆ‡åŠŸèƒ½å‡½å¼æ›è¼‰ ---
        window.notify = function(m, t) {
            const c = document.getElementById("toast-container");
            const div = document.createElement("div");
            div.className = "toast";
            div.style.borderLeftColor = t === 'error' ? 'var(--error)' : 'var(--p)';
            div.innerText = m;
            c.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        };

        window.showPage = function(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'statPage') { initChartFrame(); renderLeaderboard(); }
            window.scrollTo(0, 0);
        };

        async function init() {
            if (!window.ethereum) return;
            provider = new ethers.providers.Web3Provider(window.ethereum);
            const { signInAnonymously, auth } = window.govDB;
            await signInAnonymously(auth).catch(() => {});

            if (sessionStorage.getItem('explicitLogout') === 'true') {
                document.getElementById("connBtn").style.display = "block";
                return;
            }
            try {
                const accounts = await provider.listAccounts();
                if (accounts.length > 0) await setupSession(accounts[0]);
                else document.getElementById("connBtn").style.display = "block";
            } catch (e) {}
        }

        async function setupSession(addr) {
            try {
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111) await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: "0xaa36a7" }] });
                signer = provider.getSigner();
                userAddr = addr;
                contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

                loadPersistedData();
                await syncUserDashboard();
                renderPolls();
                
                contract.on("PollCreated", () => { renderPolls(); renderLeaderboard(); });
                contract.on("VoteCast", () => { if(currentPid) viewDetail(currentPid); renderPolls(); renderLeaderboard(); });

                window.notify("éŒ¢åŒ…é€£ç·šæˆåŠŸ", "success");
            } catch (e) { console.error(e); }
        }

        async function syncUserDashboard() {
            if (!contract || !userAddr) return;
            try {
                const dash = await contract.getUserDashboard(userAddr);
                isRegisteredOnChain = dash.isRegistered;
                onChainRep = dash.reputation.toNumber();
                userCredits = dash.credits.toNumber();
                
                document.getElementById("regAlert").style.display = isRegisteredOnChain ? "none" : "block";
                document.getElementById("netStatus").innerText = "Sepolia å·²é€£ç·š";
                document.getElementById("netStatus").classList.add("net-ok");
                document.getElementById("userInfo").style.display = "flex";
                document.getElementById("connBtn").style.display = "none";
                document.getElementById("discoBtn").style.display = "block";
                updateUI();
                
                if(isRegisteredOnChain) {
                    const { db, appId, doc, setDoc } = window.govDB;
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'discovery_pool', userAddr.toLowerCase()), { address: userAddr.toLowerCase(), lastSeen: Date.now() }, { merge: true });
                }
            } catch (e) { isRegisteredOnChain = false; }
        }

        function updateUI() {
            if (!userAddr) return;
            // å°è¦½åˆ—ï¼šåƒ…éˆä¸Šæ•¸å€¼
            document.getElementById("navRep").innerText = "Rep: " + onChainRep;
            document.getElementById("navName").innerText = userAddr.substring(0, 6) + "...";
            document.getElementById("navAvatar").src = `https://api.dicebear.com/7.x/identicon/svg?seed=${userAddr}`;
            
            // å€‹äººæª”æ¡ˆï¼šéˆä¸Š + æœ¬åœ°
            const totalRep = onChainRep + localRepBonus;
            const rs = document.getElementById("repStatus"); if(rs) rs.innerText = `éˆä¸Šè²æœ›: ${onChainRep}`;
            document.getElementById("bonusValue").innerText = localRepBonus;
            document.getElementById("profileAvatar").src = `https://api.dicebear.com/7.x/identicon/svg?seed=${userAddr}`;
            
            let lvl = "ğŸŒ± æ²»ç†èŒèŠ½"; let fill = (totalRep / 50) * 100;
            if (totalRep > 50) { lvl = "ğŸ›¡ï¸ æ²»ç†åŸ·æ³•è€…"; fill = ((totalRep - 50) / 100) * 100; }
            if (totalRep > 150) { lvl = "ğŸ‘‘ æ²»ç†å‚³å¥‡"; fill = ((totalRep - 150) / 350) * 100; }
            document.getElementById("lvlTitle").innerText = "ç•¶å‰ç­‰ç´šï¼š" + lvl;
            document.getElementById("lvlFill").style.width = Math.min(fill, 100) + "%";
            
            const tc = document.getElementById("titleCollection"); if(tc) tc.innerHTML = userTitles.map(t => `<span class="title-badge">${t}</span>`).join('') || '<small>å°šç„¡ç¨±è™Ÿ</small>';
        }

        // --- æ ¸å¿ƒå„ªåŒ–ï¼šéˆä¸Šæ¬Šå¨æ’è¡Œæ¦œ ---
        async function renderLeaderboard() {
            const list = document.getElementById("leaderContent");
            const scanStatus = document.getElementById("leaderScanStatus");
            const { db, appId, collection, getDocs, auth } = window.govDB;
            if (!contract || !list || !auth.currentUser) return;

            try {
                scanStatus.style.display = 'block';
                const snapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'discovery_pool'));
                const allAddresses = new Set();
                snapshot.forEach(doc => allAddresses.add(doc.id));
                if(userAddr) allAddresses.add(userAddr.toLowerCase());

                const leaderData = [];
                for (let addr of Array.from(allAddresses).slice(0, 20)) {
                    try {
                        const dash = await contract.getUserDashboard(addr);
                        if (dash.isRegistered) {
                            leaderData.push({ 
                                addr, 
                                // æ’è¡Œæ¦œåªå–éˆä¸Šæ•¸æ“š
                                rep: dash.reputation.toNumber(), 
                                isMe: userAddr && addr.toLowerCase() === userAddr.toLowerCase() 
                            });
                        }
                    } catch (e) {}
                }

                leaderData.sort((a, b) => b.rep - a.rep);
                list.innerHTML = leaderData.map((l, i) => `
                    <div class="leader-item">
                        <span class="leader-rank">#${i+1}</span>
                        <span class="leader-addr">${l.addr.substring(0, 10)}...${l.addr.substring(34)}${l.isMe ? '<span class="me-tag">YOU</span>' : ''}</span>
                        <span class="leader-rep">${l.rep} Rep</span>
                    </div>`).join('');
                scanStatus.style.display = 'none';
                updateTrendChart();
            } catch (e) { scanStatus.innerText = "ç¯€é»ç¹å¿™ä¸­ï¼Œé»æ­¤åˆ·æ–°"; }
        }
        window.renderLeaderboard = renderLeaderboard;

        // --- æ ¸å¿ƒå„ªåŒ–ï¼šäº‹ä»¶è¶¨å‹¢çµ±è¨ˆåœ– ---
        async function updateTrendChart() {
            if(!chartInstance) return;
            try {
                const currentBlock = await provider.getBlockNumber();
                const startBlock = Math.max(DEPLOY_BLOCK, currentBlock - 10000);
                
                const [voteEvents, pollEvents] = await Promise.all([
                    contract.queryFilter("VoteCast", startBlock),
                    contract.queryFilter("PollCreated", startBlock)
                ]);
                
                const totalActivity = voteEvents.length + pollEvents.length;
                chartInstance.data.datasets[0].data = [totalActivity * 0.3, totalActivity * 0.6, totalActivity];
                chartInstance.update();
            } catch(e) {}
        }

        window.connectWalletFlow = async function() {
            try { sessionStorage.removeItem('explicitLogout'); const accs = await provider.send("eth_requestAccounts", []); if(accs.length > 0) await setupSession(accs[0]); } catch (e) { window.notify("é€£ç·šå¤±æ•—", "error"); }
        };
        window.handleDailyCheckIn = function() {
            localRepBonus += 10; updateUI(); savePersistedData(); window.notify("ç°½åˆ°æˆåŠŸï¼æœ¬åœ°ç©åˆ†å·²ç´¯åŠ ", "success"); confetti();
        };
        window.handleRegisterOnChain = async function() {
            try { window.notify("åŸ·è¡Œè¨»å†Šä¸­...", "info"); const tx = await contract.register("User", "default"); await tx.wait(); await syncUserDashboard(); } catch (e) { window.notify("å¤±æ•—", "error"); }
        };
        window.handleCreatePoll = async function() {
            if(!isRegisteredOnChain) return window.notify("è«‹å…ˆè¨»å†Š", "error");
            try { const tx = await contract.createPoll(document.getElementById("topic").value, document.getElementById("modeSelect").value, Array.from(document.querySelectorAll(".cand-name")).map(i=>i.value), Array.from(document.querySelectorAll(".cand-uid")).map(i=>i.value), 1440); await tx.wait(); renderPolls(); window.showPage('listPage'); } catch(e) {}
        };
        window.addCandidateInput = function() {
            const div = document.createElement("div"); div.className = "edit-card-row";
            div.innerHTML = `<input type="text" class="cand-name" placeholder="åç¨±"><input type="text" class="cand-uid" placeholder="CID">`;
            document.getElementById("candidateInputsContainer").appendChild(div);
        };
        window.disconnectWallet = function() { sessionStorage.setItem('explicitLogout', 'true'); location.reload(); };

        function resolveCandidateImage(uid) {
            const cidRegex = /(Qm[1-9A-HJ-NP-Za-km-z]{44}|b[a-z2-7]{58}|bafy[a-zA-Z0-9]{40,}|bafk[a-zA-Z0-9]{40,})/;
            const match = (uid||'').match(cidRegex);
            return match ? `https://ipfs.io/ipfs/${match[0]}` : `https://api.dicebear.com/7.x/identicon/svg?seed=${uid||'Uni'}`;
        }

        async function viewDetail(pid) {
            currentPid = pid; window.showPage('detailPage');
            try {
                const p = await contract.allPolls(pid);
                const candidates = await contract.getCandidates(pid);
                const modes = ["ä¸€èˆ¬", "å¹³æ–¹", "å‹Ÿè³‡", "æ’åº", "æ¬Šé‡"];
                document.getElementById("pollInfo").innerHTML = `<h1>${p.topic}</h1><span class="title-badge">${modes[p.mode]}æ¨¡å¼</span><p>ç™¼èµ·äºº: ${p.creator}</p>`;
                document.getElementById("oracleGuess").innerHTML = candidates.map((c, i) => `<option value="${i}">${c.name}</option>`).join('');
                document.getElementById("creatorEditSection").style.display = (p.creator.toLowerCase() === userAddr.toLowerCase() && p.totalVotes.toNumber() === 0) ? "block" : "none";
                document.getElementById("votingUI").innerHTML = candidates.map((c, i) => `
                    <div class="card" style="text-align:center">
                        <div class="cand-img-wrap"><img src="${resolveCandidateImage(c.uid)}" class="cand-img" onerror="this.src='https://api.dicebear.com/7.x/identicon/svg?seed=Err'"></div>
                        <h3>${c.name}</h3><p>å¾—ç¥¨: ${c.voteWeight.toString()}</p>
                        <button onclick="govCastVote(${pid}, ${i}, ${p.mode === 1 ? 1 : 0})">${p.mode === 1 ? 'æŠ•å¹³æ–¹ç¥¨' : 'æŠ•ä¸‹ä¸€ç¥¨'}</button>
                        ${p.mode === 1 ? `<input type="number" id="qv-${i}" placeholder="ç¥¨æ•¸" style="margin-top:5px;">` : ''}
                    </div>`).join('');
            } catch (e) {}
        }
        window.govCastVote = async function(pid, cid, qv) {
            const val = qv ? document.getElementById(`qv-${cid}`).value : 1;
            try { const tx = await contract.castVote(pid, cid, val); await tx.wait(); confetti(); viewDetail(pid); } catch(e) { window.notify("å¤±æ•—", "error"); }
        };

        function initChartFrame() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: ['æ—¥å‰','æ˜¨æ—¥','ä»Šæ—¥'], datasets: [{ label: 'æ²»ç†æ´»è·ƒäº‹ä»¶', data: [0, 0, 0], borderColor: '#6366f1', fill: true }] }, options: { plugins: { legend: { labels: { color: '#fff' } } } } });
        }

        function spinWheel() {
            const deg = 1800 + Math.random() * 1800;
            document.getElementById("wheel").style.transform = `rotate(${deg}deg)`;
            setTimeout(() => {
                const res = ["æ²»ç†å…ˆé‹’", "å…±è­˜ä¹‹çœ¼", "çœŸç†è­·ç›¾"][Math.floor(Math.random() * 3)];
                document.getElementById("wheelResult").innerText = "ç²å¾—ï¼š"+res;
                if(!userTitles.includes(res)) { userTitles.push(res); updateUI(); savePersistedData(); }
                confetti();
            }, 4000);
        }
        window.spinWheel = spinWheel;

        async function renderPolls() {
            const grid = document.getElementById("pollGrid");
            if(!contract) return;
            try {
                const count = (await contract.getPollCount()).toNumber();
                let html = "";
                for(let i = count - 1; i >= 0; i--) {
                    const p = await contract.allPolls(i);
                    if (p.topic.startsWith("[DELETED]")) continue;
                    html += `<div class="card" onclick="viewDetail(${i})"><h3>${p.topic}</h3><p>ç¸½ç¥¨æ•¸ï¼š${p.totalVotes.toString()}</p></div>`;
                }
                grid.innerHTML = html || '<p>å°šç„¡è­°æ¡ˆ</p>';
            } catch (e) {}
        }

        function loadPersistedData() { if(!userAddr) return; const k = userAddr.toLowerCase(); userTitles = JSON.parse(localStorage.getItem(`titles_${k}`) || "[]"); localRepBonus = parseInt(localStorage.getItem(`bonus_${k}`) || "0"); }
        function savePersistedData() { if(!userAddr) return; const k = userAddr.toLowerCase(); localStorage.setItem(`titles_${k}`, JSON.stringify(userTitles)); localStorage.setItem(`bonus_${k}`, localRepBonus.toString()); }

        window.handleOracleBet = () => window.notify("é æ¸¬å·²æäº¤", "success");
        window.handleEditPollMetadata = () => window.notify("åŒæ­¥ä¸­...", "info");
        window.handleDeletePoll = () => window.notify("è™•ç†ä¸­...", "info");
        window.filterPolls = () => {
            const q = document.getElementById("searchBar").value.toLowerCase();
            document.querySelectorAll('#pollGrid .card').forEach(c => { c.style.display = c.innerText.toLowerCase().includes(q) ? 'block' : 'none'; });
        };

        window.onload = init;
    </script>
</body>

</html>
